<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تسجيل الدخول - ساعتي</title>
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--ink:#0f172a;--muted:#475569;--line:#e2e8f0;--accent:#3b82f6}
    *{box-sizing:border-box}
    body{
      font-family:system-ui,"Noto Naskh Arabic","Cairo",Tahoma,Arial,sans-serif;
      background:var(--bg);color:var(--ink);
      display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;padding:12px
    }
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 26px rgba(15,23,42,.08);
      padding:18px;max-width:380px;width:100%;text-align:center}
    h2{margin:0 0 6px}
    p.small{margin:0 0 12px;color:var(--muted);font-size:14px}
    .row{display:grid;gap:8px;margin-top:8px}
    input{
      width:100%;height:46px;padding:10px;border-radius:10px;border:1px solid var(--line);
      text-align:center;font-size:15px;background:#fff;color:#0f172a
    }
    .btn{width:100%;height:44px;padding:10px;border-radius:10px;border:1px solid var(--line);
      cursor:pointer;font-weight:700;background:#fff;color:#0f172a;transition:transform .05s ease}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:#3b82f6;border-color:#3b82f6;color:#fff}
    .btn-primary[disabled]{opacity:.6;cursor:default}
    .btn-ghost{background:#f3f4f6;border-color:#e5e7eb}
    .btn-google{display:flex;justify-content:center;align-items:center;gap:8px;background:#fff}
    .err{display:none;margin:8px 0;padding:8px;border-radius:10px;background:#fee2e2;color:#7f1d1d;font-size:14px;border:1px solid #fecaca}
    .ok{display:none;margin:8px 0;padding:8px;border-radius:10px;background:#ecfdf5;color:#065f46;font-size:14px;border:1px solid #86efac}
    .foot{margin-top:12px;font-size:13px}
    .foot a{color:#3b82f6;text-decoration:none}
    .muted{color:#94a3b8;font-weight:600}
    .sp{display:inline-block;min-width:1.2em;animation:blink 1s steps(1,end) infinite}
    @keyframes blink{50%{opacity:0}}
  </style>
</head>
<body>
  <div class="card">
    <h2>تسجيل الدخول</h2>
    <p class="small">سجّل أو أنشئ حسابًا لمزامنة بياناتك عبر الأجهزة.</p>

    <div id="okBox" class="ok"></div>
    <div id="errorBox" class="err"></div>

    <div class="row">
      <input id="email" type="email" autocomplete="username" placeholder="البريد الإلكتروني" />
      <input id="password" type="password" autocomplete="current-password" placeholder="كلمة المرور (٦ أحرف على الأقل)" />
      <button id="loginBtn" class="btn btn-primary">دخول</button>
      <button id="signupBtn" class="btn btn-ghost">إنشاء حساب جديد</button>
      <button id="googleBtn" class="btn btn-google">
        <img alt="Google" src="https://www.svgrepo.com/show/475656/google-color.svg" width="18" height="18" />
        دخول باستخدام Google
      </button>
      <button id="skipBtn" class="btn btn-ghost">تخطي الآن</button>
    </div>

    <div class="foot">← <a href="index.html">العودة للتطبيق</a></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getAuth,
      setPersistence,
      browserLocalPersistence,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      GoogleAuthProvider,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

    // نفس إعداداتك
    const firebaseConfig = {
      apiKey: "AIzaSyBpzQ4GRDzdYCuMvsj3rrWN8Ck0GLHiB2g",
      authDomain: "saaati-pro.firebaseapp.com",
      projectId: "saaati-pro",
      storageBucket: "saaati-pro.firebasestorage.app",
      messagingSenderId: "719485178559",
      appId: "1:719485178559:web:56460b57bb0560d8496c0a",
      measurementId: "G-2KBHPQP07X"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);
    const provider = new GoogleAuthProvider();

    // عناصر
    const emailInput  = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const errorBox = document.getElementById("errorBox");
    const okBox = document.getElementById("okBox");
    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const googleBtn = document.getElementById("googleBtn");
    const skipBtn = document.getElementById("skipBtn");

    // خرائط رسائل أخطاء لطيفة
    const MSG = {
      "auth/invalid-email":"البريد الإلكتروني غير صالح.",
      "auth/missing-email":"الرجاء إدخال البريد الإلكتروني.",
      "auth/missing-password":"الرجاء إدخال كلمة المرور.",
      "auth/weak-password":"كلمة المرور ضعيفة (على الأقل ٦ أحرف).",
      "auth/wrong-password":"كلمة المرور غير صحيحة.",
      "auth/user-not-found":"لا يوجد حساب بهذا البريد.",
      "auth/email-already-in-use":"هذا البريد مستخدم مسبقًا.",
      "auth/popup-closed-by-user":"تم إغلاق نافذة Google قبل الإكمال.",
      "auth/cancelled-popup-request":"طلب سابق قيد التنفيذ.",
      "default":"حدث خطأ غير متوقع. حاول مجددًا."
    };

    function show(box, msg){
      box.textContent = msg;
      box.style.display = "block";
      setTimeout(()=> box.style.display="none", 4000);
    }
    function showError(code){ show(errorBox, MSG[code] || MSG.default + " ("+code+")"); }
    function showOk(msg){ show(okBox, msg); }
    function setBusy(b){
      [loginBtn, signupBtn, googleBtn].forEach(btn=>{
        btn.disabled = b;
        if(b){
          if(!btn.dataset.label){ btn.dataset.label = btn.textContent; }
          btn.textContent = btn.dataset.label + " …";
        }else{
          if(btn.dataset.label){ btn.textContent = btn.dataset.label; btn.dataset.label=""; }
        }
      });
    }

    // إعادة توجيه إذا المستخدم مسجّل أصلاً
    onAuthStateChanged(auth, (user)=>{
      if(user){ window.location.href = "index.html"; }
    });

    // دعم نتيجة Google بعد redirect (موبايل)
    try{ await getRedirectResult(auth); }catch(e){ /* تجاهل*/ }

    // تحقق سريع
    function validateEmailPass(){
      const email = (emailInput.value||"").trim();
      const pass  = (passwordInput.value||"").trim();
      if(!email) throw {code:"auth/missing-email"};
      if(!pass) throw {code:"auth/missing-password"};
      if(pass.length < 6) throw {code:"auth/weak-password"};
      return {email, pass};
    }

    // تسجيل بالبريد
    loginBtn.onclick = async ()=>{
      try{
        const {email, pass} = validateEmailPass();
        setBusy(true);
        await signInWithEmailAndPassword(auth, email, pass);
        window.location.href = "index.html";
      }catch(err){ showError(err.code || "default"); }
      finally{ setBusy(false); }
    };

    // إنشاء حساب
    signupBtn.onclick = async ()=>{
      try{
        const {email, pass} = validateEmailPass();
        setBusy(true);
        await createUserWithEmailAndPassword(auth, email, pass);
        showOk("تم إنشاء الحساب بنجاح ✅");
        window.location.href = "index.html";
      }catch(err){ showError(err.code || "default"); }
      finally{ setBusy(false); }
    };

    // Google: جرّب Popup ثم Redirect للموبايل
    googleBtn.onclick = async ()=>{
      try{
        setBusy(true);
        try{
          await signInWithPopup(auth, provider);
        }catch(e){
          // في iOS/Android قد يُحظر popup
          await signInWithRedirect(auth, provider);
          return; // سيعود عبر getRedirectResult
        }
        window.location.href = "index.html";
      }catch(err){ showError(err.code || "default"); }
      finally{ setBusy(false); }
    };

    // تخطي
    skipBtn.onclick = ()=> window.location.href = "index.html";

    // Enter = تنفيذ دخول
    [emailInput, passwordInput].forEach(el=>{
      el.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ loginBtn.click(); } });
    });
  </script>
</body>
</html>
