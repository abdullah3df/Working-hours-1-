<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Saaati â€” Home (Fixed)</title>
<style>
:root{
  --bg:#f6f8fb;--card:#fff;--ink:#0f172a;--muted:#475569;--line:#e2e8f0;
  --ok:#16a34a;--warn:#ef4444;--accent:#3b82f6;--shadow:0 12px 30px rgba(15,23,42,.08);
}
.dark{--bg:#0b1020;--card:#0e1528;--ink:#e5e7eb;--muted:#94a3b8;--line:#1f2b40;--accent:#60a5fa;--shadow:0 18px 40px rgba(0,0,0,.4)}
*{box-sizing:border-box}
body{margin:0;background:
 radial-gradient(1200px 600px at 10% -10%,rgba(59,130,246,.08),transparent),
 radial-gradient(1000px 600px at 110% -20%,rgba(22,163,74,.08),transparent),
 var(--bg);color:var(--ink);font-family:system-ui,"Noto Naskh Arabic","Cairo",Tahoma,Arial,sans-serif}
.topbar{position:sticky;top:0;z-index:60;background:color-mix(in srgb, var(--card) 92%, transparent);
 backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
.dark .topbar{background:#0c1426cc}
.topbar .inner{max-width:1080px;margin:0 auto;padding:10px 14px;
 display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;min-height:56px}
.brand{font-weight:900;display:flex;align-items:center;gap:8px}
.btn{height:38px;padding:6px 12px;border-radius:12px;border:1px solid var(--line);
 background:var(--card);color:var(--ink);cursor:pointer}
.user-pill{padding:8px 12px;border-radius:999px;border:1px solid var(--line);
 background:var(--card);white-space:nowrap;max-width:32ch;overflow:hidden;text-overflow:ellipsis;box-shadow:var(--shadow)}
.wrap{max-width:980px;margin:18px auto 48px;padding:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
h1{margin:0 0 8px;font-size:22px}
p.small{color:var(--muted);margin:0 0 12px}
.input{width:100%;height:46px;padding:10px;border-radius:12px;border:1px solid var(--line);
 background:#fff;color:#0f172a;font-weight:700}
.textarea{width:100%;min-height:70px;border:1px solid var(--line);
 border-radius:12px;background:#fff;color:#0f172a;padding:10px;resize:vertical}
.dark .textarea{background:#0a1222;color:#e5e7eb;border-color:#1f2b40}
.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:12px;margin-top:10px}
.kcard{border:1px solid var(--line);background:#fff;border-radius:14px;padding:12px;text-align:center}
.kcard h3{margin:0;color:var(--muted);font-size:13px}
.kcard .val{font-size:20px;font-weight:800;margin-top:4px}
.toast{position:fixed;right:16px;top:16px;z-index:120;background:var(--card);color:var(--ink);
 border:1px solid var(--line);border-radius:12px;padding:10px 12px;box-shadow:var(--shadow);
 opacity:0;transform:translateY(-6px);pointer-events:none;transition:.25s ease}
.toast.show{opacity:1;transform:translateY(0)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;
 justify-content:center;padding:16px;z-index:80}
.modal.open{display:flex}
.dialog{background:var(--card);border:1px solid var(--line);border-radius:16px;max-width:920px;
 width:100%;padding:16px;max-height:85vh;overflow:auto;box-shadow:var(--shadow)}
</style>
</head>
<body>
<div class="topbar">
  <div class="inner">
    <button id="menuToggle" class="btn">â˜° Menu</button>
    <div class="brand">â±ï¸ <span id="brandTxt">Saaati</span></div>
    <div id="userPill" class="user-pill">Guest</div>
  </div>
</div>

<div class="wrap">
  <div class="card" id="dayCard">
    <h1>Daily Entry</h1>
    <p class="small">Enter start, end and break. Autosaved locally.</p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <input id="dayDate" type="date" class="input">
      <div id="dayName" class="input" style="text-align:center;font-weight:700;background:#f8fafc"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">
      <input id="dayStart" type="time" class="input">
      <input id="dayEnd" type="time" class="input">
      <input id="dayBreak" type="number" class="input" min="0" step="5" value="30">
    </div>
    <div style="margin-top:12px">
      <select id="dayStatus" class="input">
        <option value="work">Work</option>
        <option value="vacation">Vacation</option>
        <option value="sick">Sick</option>
        <option value="absent">Absent</option>
      </select>
    </div>
    <div id="reasonWrap" style="margin-top:10px;display:none">
      <input id="dayReason" class="input" placeholder="Reason / Note">
    </div>
    <textarea id="taskNote" class="textarea" placeholder="Task Note"></textarea>
    <div class="kpis">
      <div class="kcard"><h3>Work Hours</h3><div class="val" id="dWorkHours">0:00</div></div>
      <div class="kcard"><h3>Net Today</h3><div class="val" id="dNet">0:00</div></div>
      <div class="kcard"><h3>Overtime</h3><div class="val" id="dOT">0:00</div></div>
    </div>
    <div style="text-align:right;margin-top:16px">
      <button id="doExport" class="btn">ğŸ“¦ Export</button>
    </div>
  </div>
</div>

<div id="toast" class="toast">Saved âœ…</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
function h2m(h){if(!h)return 0;const[H,M]=h.split(':').map(Number);return H*60+(M||0);}
function m2h(m){m=Math.max(0,Math.floor(m));const hh=Math.floor(m/60),mm=m%60;return hh+":"+String(mm).padStart(2,'0');}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1200);}
  /* ====== State & Helpers ====== */
const dayDate   = document.getElementById('dayDate');
const dayStart  = document.getElementById('dayStart');
const dayEnd    = document.getElementById('dayEnd');
const dayBreak  = document.getElementById('dayBreak');
const dayStatus = document.getElementById('dayStatus');
const dayReason = document.getElementById('dayReason');
const taskNote  = document.getElementById('taskNote');
const reasonWrap= document.getElementById('reasonWrap');

const dNet      = document.getElementById('dNet');
const dOT       = document.getElementById('dOT');
const dWorkHours= document.getElementById('dWorkHours');
const dayName   = document.getElementById('dayName');

const doExport  = document.getElementById('doExport');

const DAILY_BASE_MIN = 8 * 60; // 8 Ø³Ø§Ø¹Ø§Øª Ø£Ø³Ø§Ø³ Ø§Ù„ÙŠÙˆÙ…

function updateDayName() {
  try {
    const dt = new Date(dayDate.value);
    const fmt = new Intl.DateTimeFormat('ar', { weekday: 'long' });
    dayName.textContent = fmt.format(dt);
  } catch {
    dayName.textContent = 'â€”';
  }
}

/* Ø­ÙØ³Ø§Ø¨ ØµØ§ÙÙŠ Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ */
function compute() {
  const s = dayStart.value;
  const e = dayEnd.value;
  const br = Math.max(0, parseInt(dayBreak.value || '0', 10));

  if (!s || !e) {
    dNet.textContent = '0:00';
    dOT.textContent  = '0:00';
    dWorkHours.textContent = '0:00';
    return;
  }
  let sm = h2m(s), em = h2m(e);
  if (em < sm) em += 1440; // Ø¹Ø¨ÙˆØ± Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„
  const net = Math.max(0, (em - sm) - br);
  const ot  = Math.max(0, net - DAILY_BASE_MIN);

  dNet.textContent       = m2h(net);
  dOT.textContent        = m2h(ot);
  dWorkHours.textContent = m2h(net);
}

/* ØªØ®Ø²ÙŠÙ†/Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙŠÙˆÙ… */
function keyForDate(iso)   { return 'day-' + iso; }
function captureForm() {
  return {
    date: dayDate.value,
    start: dayStart.value || '',
    end: dayEnd.value || '',
    break: Math.max(0, parseInt(dayBreak.value || '0', 10)),
    status: dayStatus.value || 'work',
    reason: dayReason.value || '',
    taskNote: taskNote.value || ''
  };
}
function fillForm(p) {
  dayStart.value = p.start || '';
  dayEnd.value   = p.end   || '';
  dayBreak.value = (p.break ?? 30);
  dayStatus.value= p.status || 'work';
  dayReason.value= p.reason || '';
  taskNote.value = p.taskNote || '';
  reasonWrap.style.display = (dayStatus.value === 'work') ? 'none' : 'block';
  compute();
}
function saveDayLocal(silentToast=false) {
  const p = captureForm();
  localStorage.setItem(keyForDate(p.date), JSON.stringify(p));
  if (!silentToast) showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
}
function loadDay() {
  const raw = localStorage.getItem(keyForDate(dayDate.value));
  if (raw) {
    try { fillForm(JSON.parse(raw)); }
    catch { /* ignore and keep defaults */ }
  } else {
    fillForm({
      start:'', end:'', break: parseInt(dayBreak.value || '30',10),
      status:'work', reason:'', taskNote:''
    });
  }
}

/* ====== Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø²Ø¹Ø§Ø¬: Ù„Ø§ Ù†ÙØªØ­ Ø£ÙŠ Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø­Ø±Ù ======
   Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…ÙØ¤ÙØ²Ù’Ù…ÙÙ† (debounced autosave) Ù„ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„. */
let saveTimer = null;
function scheduleAutosave() {
  compute();
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(()=> saveDayLocal(true), 500); // Ù†ØµÙ Ø«Ø§Ù†ÙŠØ©
}

/* Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø³Ø¨Ø¨ Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© */
dayStatus.addEventListener('change', () => {
  reasonWrap.style.display = (dayStatus.value === 'work') ? 'none' : 'block';
  scheduleAutosave();
});

/* Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… â†’ Ø­ÙØ¸ Ù…Ø±ÙŠØ­ Ø¨Ø¯ÙˆÙ† ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¥Ø²Ø¹Ø§Ø¬ */
[dayStart, dayEnd, dayBreak, dayReason, taskNote].forEach(el => {
  el.addEventListener('input', scheduleAutosave);
});

/* ØªØºÙŠÙŠØ± Ø§Ù„ØªØ§Ø±ÙŠØ® â†’ ØªØ­Ù…ÙŠÙ„ */
dayDate.addEventListener('change', () => { updateDayName(); loadDay(); });

/* ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ© */
(function init() {
  try { dayDate.valueAsDate = new Date(); }
  catch { dayDate.value = new Date().toISOString().slice(0,10); }
  updateDayName();
  loadDay();
  compute();
})();

/* ====== Ø§Ù„ØªØµØ¯ÙŠØ± (PNG/JSONØŒ ÙŠÙˆÙ…/Ø´Ù‡Ø±/Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ†) ====== */
function tsNow() {
  const d=new Date(), p=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
}
function mthead(lang='ar') {
  // Ø±Ø¤ÙˆØ³ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±
  return ['Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©','Ø§Ù„Ù†Ù‡Ø§ÙŠØ©','Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©','Ø§Ù„ØµØ§ÙÙŠ','Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ'];
}
function statusLabel(v) {
  return ({work:'Ø¹Ù…Ù„', vacation:'Ø¥Ø¬Ø§Ø²Ø©', sick:'Ù…Ø±Ø¶', absent:'ØºÙŠØ§Ø¨'})[v] || v || 'Ø¹Ù…Ù„';
}
function buildDayPNGNode(locale='ar') {
  const p = captureForm();
  const node = document.createElement('div');
  node.dir = 'rtl';
  node.lang = locale;
  node.style.cssText='font-family: system-ui, "Noto Naskh Arabic", Tahoma; padding:16px; color:#0f172a; background:#ffffff; width:820px;';
  let html = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h2 style="margin:0">Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h2><div>${tsNow()}</div>
    </div>
    <div style="margin:6px 0">Ø§Ù„ØªØ§Ø±ÙŠØ®: <strong>${p.date}</strong></div>
    <div style="margin:6px 0">Ø§Ù„Ø¯Ø®ÙˆÙ„: <strong>${p.start || '-'}</strong> â€” Ø§Ù„Ø®Ø±ÙˆØ¬: <strong>${p.end || '-'}</strong> â€” Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø© (Ø¯): <strong>${p.break || 0}</strong></div>
    <div style="margin:6px 0">ØµØ§ÙÙŠ Ø§Ù„ÙŠÙˆÙ…: <strong>${dNet.textContent}</strong> â€” Ø¥Ø¶Ø§ÙÙŠ Ø§Ù„ÙŠÙˆÙ…: <strong>${dOT.textContent}</strong> â€” Ø£Ø³Ø§Ø³ Ø§Ù„ÙŠÙˆÙ… (Ø³): <strong>8</strong></div>
    <div style="margin:10px 0"><strong>Ø­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ…:</strong> ${statusLabel(p.status)}</div>`;
  if (p.status !== 'work' && p.reason) {
    html += `<div style="margin:6px 0"><strong>Ø³Ø¨Ø¨ / Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ${p.reason}</div>`;
  }
  if (p.taskNote) {
    html += `<div style="margin:6px 0"><strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù…Ù‡Ù…Ø©:</strong> ${p.taskNote}</div>`;
  }
  node.innerHTML = html;
  return node;
}

function buildRangeData(d0, d1, basePerDay=DAILY_BASE_MIN) {
  const rows=[], annotations=[];
  for (let d = new Date(d0); d <= d1; d.setDate(d.getDate()+1)) {
    const iso = d.toISOString().slice(0,10);
    const raw = localStorage.getItem(keyForDate(iso));
    if (!raw) continue;
    try {
      const p = JSON.parse(raw);
      if (p.start && p.end) {
        let sm=h2m(p.start), em=h2m(p.end); if (em<sm) em+=1440;
        const net = Math.max(0,(em-sm)-parseInt(p.break||0,10));
        const ot  = Math.max(0,net-basePerDay);
        rows.push([iso, p.start, p.end, p.break||0, m2h(net), m2h(ot)]);
      }
      const nonWork = p.status && p.status!=='work';
      const hasTask = p.taskNote && p.taskNote.trim().length>0;
      if (nonWork || hasTask) {
        annotations.push({
          date: iso,
          statusLabel: statusLabel(p.status),
          reason: p.reason || '',
          taskNote: p.taskNote || ''
        });
      }
    } catch { /* ignore */ }
  }
  rows.sort((a,b)=>a[0].localeCompare(b[0]));
  annotations.sort((a,b)=>a.date.localeCompare(b.date));
  return { rows, annotations };
}

function buildPeriodPNGNode(title, periodLabel, rows, annotations, locale='ar') {
  const node = document.createElement('div');
  node.dir = 'rtl';
  node.lang = locale;
  node.style.cssText='font-family: system-ui, "Noto Naskh Arabic", Tahoma; padding:16px; color:#0f172a; background:#ffffff; width:980px;';
  let html = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h2 style="margin:0">${title}</h2><div>${tsNow()}</div>
    </div>
    <div style="margin-bottom:8px;font-weight:700">${periodLabel}</div>
    <table style="width:100%;border-collapse:separate;border-spacing:0 8px">
      <thead><tr>${mthead(locale).map(h=>`<th style="text-align:center;color:#475569;font-size:13px">${h}</th>`).join('')}</tr></thead>
      <tbody>`;
  rows.forEach(r=>{
    html += `<tr style="background:#fff;border:1px solid #e2e8f0">
      <td style="padding:8px 10px">${r[0]}</td>
      <td style="padding:8px 10px">${r[1]}</td>
      <td style="padding:8px 10px">${r[2]}</td>
      <td style="padding:8px 10px">${r[3]}</td>
      <td style="padding:8px 10px">${r[4]}</td>
      <td style="padding:8px 10px">${r[5]}</td>
    </tr>`;
  });
  html += `</tbody></table>`;

  if (annotations.length) {
    html += `<div style="margin-top:12px"><h3 style="margin:8px 0">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
      <table style="width:100%;border-collapse:separate;border-spacing:0 8px">
      <thead><tr>${['Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ø­Ø§Ù„Ø©','Ø³Ø¨Ø¨ / Ù…Ù„Ø§Ø­Ø¸Ø©','Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù…Ù‡Ù…Ø©'].map(h=>`<th style="text-align:center;color:#475569;font-size:13px">${h}</th>`).join('')}</tr></thead>
      <tbody>`;
    annotations.forEach(a=>{
      html += `<tr style="background:#fff;border:1px solid #e2e8f0">
        <td style="padding:8px 10px">${a.date}</td>
        <td style="padding:8px 10px">${a.statusLabel}</td>
        <td style="padding:8px 10px">${a.reason || '-'}</td>
        <td style="padding:8px 10px">${a.taskNote || '-'}</td>
      </tr>`;
    });
    html += `</tbody></table></div>`;
  }

  node.innerHTML = html;
  return node;
}

async function nodeToPNGAndDownload(node, filename) {
  if (typeof html2canvas === 'undefined') {
    alert('Image export unavailable.');
    return;
  }
  document.body.appendChild(node);
  const canvas = await html2canvas(node, { scale: 2, backgroundColor: '#ffffff' });
  const dataURL = canvas.toDataURL('image/png');
  const a = document.createElement('a');
  a.href = dataURL;
  a.download = filename.endsWith('.png') ? filename : `${filename}.png`;
  a.click();
  node.remove();
}

function periodLabelFromDates(start,end){
  const p=n=>String(n).padStart(2,'0');
  return `${start.getFullYear()}-${p(start.getMonth()+1)}-${p(start.getDate())}_to_${end.getFullYear()}-${p(end.getMonth()+1)}-${p(end.getDate())}`;
}

/* Ø¶ØºØ· Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± */
doExport.addEventListener('click', async () => {
  // Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø³ÙŠØ·Ø© Ø¹Ø¨Ø± prompt Ø­ØªÙ‰ ÙŠØ¹Ù…Ù„ Ø§Ù„Ø²Ø± ÙÙˆØ±Ù‹Ø§ Ø¨Ø¯ÙˆÙ† Ù†ÙˆØ§ÙØ° Ø¥Ø¶Ø§ÙÙŠØ©
  const scope  = (prompt('Scope? Ø§ÙƒØªØ¨: day / month / biweek', 'day') || 'day').toLowerCase();
  const format = (prompt('Format? Ø§ÙƒØªØ¨: png / json', 'png') || 'png').toLowerCase();

  // Ø¶Ù…Ø§Ù† Ø­ÙØ¸ Ø¢Ø®Ø± Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
  saveDayLocal(true);

  if (scope === 'day') {
    if (format === 'png') {
      const node = buildDayPNGNode('ar');
      await nodeToPNGAndDownload(node, `day-${dayDate.value}.png`);
      showToast('ØªÙ… ØªØµØ¯ÙŠØ± ØµÙˆØ±Ø© Ø§Ù„ÙŠÙˆÙ… âœ…');
    } else {
      const data = { meta:{ scope:'day', lang:'ar', date:dayDate.value, exportedAt:new Date().toISOString() }, payload: captureForm() };
      const blob = new Blob([JSON.stringify(data,null,2)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `day-${dayDate.value}.json`; a.click();
      URL.revokeObjectURL(url);
      showToast('ØªÙ… ØªØµØ¯ÙŠØ± JSON âœ…');
    }
    return;
  }

  if (scope === 'month') {
    const [y,m] = dayDate.value.split('-').map(Number);
    const first = new Date(y, m-1, 1);
    const last  = new Date(y, m, 0);
    const { rows, annotations } = buildRangeData(first, last);

    if (format === 'png') {
      const node = buildPeriodPNGNode('Ù…Ù„Ø®Øµ Ø´Ù‡Ø±ÙŠ', `${y}-${String(m).padStart(2,'0')}`, rows, annotations, 'ar');
      await nodeToPNGAndDownload(node, `month-${y}-${String(m).padStart(2,'0')}.png`);
      showToast('ØªÙ… ØªØµØ¯ÙŠØ± ØµÙˆØ±Ø© Ø§Ù„Ø´Ù‡Ø± âœ…');
    } else {
      const data = { meta:{ scope:'month', period:`${y}-${String(m).padStart(2,'0')}`, lang:'ar', exportedAt:new Date().toISOString() }, rows, annotations };
      const blob = new Blob([JSON.stringify(data,null,2)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `month-${y}-${String(m).padStart(2,'0')}.json`; a.click();
      URL.revokeObjectURL(url);
      showToast('ØªÙ… ØªØµØ¯ÙŠØ± JSON Ù„Ù„Ø´Ù‡Ø± âœ…');
    }
    return;
  }

  if (scope === 'biweek') {
    const startStr = prompt('Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† (YYYY-MM-DD)', dayDate.value) || dayDate.value;
    const start = new Date(startStr);
    const end   = new Date(start); end.setDate(end.getDate()+13); // 14 ÙŠÙˆÙ…
    const { rows, annotations } = buildRangeData(start, end);
    const label = periodLabelFromDates(start, end);

    if (format === 'png') {
      const node = buildPeriodPNGNode('Ù…Ù„Ø®Øµ Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ†', label, rows, annotations, 'ar');
      await nodeToPNGAndDownload(node, `biweek-${label}.png`);
      showToast('ØªÙ… ØªØµØ¯ÙŠØ± ØµÙˆØ±Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† âœ…');
    } else {
      const data = { meta:{ scope:'biweek', period:label, lang:'ar', exportedAt:new Date().toISOString() }, rows, annotations };
      const blob = new Blob([JSON.stringify(data,null,2)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `biweek-${label}.json`; a.click();
      URL.revokeObjectURL(url);
      showToast('ØªÙ… ØªØµØ¯ÙŠØ± JSON Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† âœ…');
    }
    return;
  }

  alert('Scope ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ. Ø§Ø³ØªØ®Ø¯Ù…: day / month / biweek');
});

/* Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙˆØ³ÙˆÙ… Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙÙŠ Part 1 */
</script>
</body>
</html>
