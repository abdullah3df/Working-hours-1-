<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<title>Saaati ‚Äî Home</title>
<style>
:root{--bg:#f6f8fb;--card:#fff;--ink:#0f172a;--muted:#475569;--line:#e2e8f0;--ok:#16a34a;--warn:#ef4444;--accent:#3b82f6;--shadow:0 12px 30px rgba(15,23,42,.08)}
.dark{--bg:#0b1020;--card:#0e1528;--ink:#e5e7eb;--muted:#94a3b8;--line:#1f2b40;--accent:#60a5fa;--shadow:0 18px 40px rgba(0,0,0,.4)}
*{box-sizing:border-box}
body{margin:0;background:radial-gradient(1200px 600px at 10% -10%,rgba(59,130,246,.08),transparent),radial-gradient(1000px 600px at 110% -20%,rgba(22,163,74,.08),transparent),var(--bg);color:var(--ink);font-family:system-ui,"Noto Naskh Arabic","Cairo",Tahoma,Arial,sans-serif}

/* Topbar */
.topbar{position:sticky;top:0;z-index:60;background:color-mix(in srgb, var(--card) 92%, transparent);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
.dark .topbar{background:#0c1426cc}
.topbar .inner{max-width:1080px;margin:0 auto;padding:10px 14px;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;min-height:56px}
.brand{font-weight:900;display:flex;align-items:center;gap:8px;white-space:nowrap;letter-spacing:.3px}
.brand-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:12px;background:var(--card);box-shadow:var(--shadow)}
.btn{height:38px;padding:6px 12px;border-radius:12px;border:1px solid var(--line);background:var(--card);color:var(--ink);cursor:pointer}
.user-pill{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:var(--card);white-space:nowrap;max-width:32ch;overflow:hidden;text-overflow:ellipsis;box-shadow:var(--shadow)}

/* Drawer */
.menu-drawer{
  position:fixed; top:56px; bottom:0; left:0; width:320px;
  background:var(--card); border-inline-start:1px solid var(--line);
  box-shadow:var(--shadow); transform:translateX(-100%); transition:transform .25s ease; z-index:70;
}
.menu-drawer.open{transform:translateX(0)}
[dir="rtl"] .menu-drawer{left:auto; right:0; transform:translateX(100%)}
[dir="rtl"] .menu-drawer.open{transform:translateX(0)}
.menu-scroller{height:100%; overflow:auto; padding:14px}
.menu-section{margin:8px 0 14px}
.menu-title{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin:0 0 8px}
.menu-row{display:flex;gap:8px;flex-wrap:wrap}
.menu-list{display:grid;gap:8px}
.hr{height:1px;background:var(--line);border:0;margin:12px 0}

/* Lang row (single line) */
.lang-chip{padding:8px 10px;border:1px solid var(--line);background:var(--card);border-radius:999px;cursor:pointer}
.lang-chip[data-active="true"]{border-color:color-mix(in srgb, var(--accent) 40%, transparent);outline:2px solid color-mix(in srgb, var(--accent) 18%, transparent)}

/* Toggle */
.switch{position:relative;display:inline-block;width:46px;height:26px;vertical-align:middle}
.switch input{display:none}
.slider{position:absolute;cursor:pointer;inset:0;background:#cbd5e1;border-radius:999px;transition:.2s}
.slider:before{content:"";position:absolute;height:22px;width:22px;left:2px;top:2px;background:white;border-radius:50%;transition:.2s}
input:checked + .slider{background:#60a5fa}
input:checked + .slider:before{transform:translateX(20px)}

/* Layout */
.wrap{max-width:980px;margin:18px auto 80px;padding:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
h1{margin:0 0 8px;font-size:22px}
p.small{color:var(--muted);margin:0 0 12px}

/* Date row */
.date-row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end;margin-bottom:8px}
.date-input label{display:block;color:var(--muted);font-size:13px;margin:0 0 4px}
.input{width:100%;height:46px;padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff;color:#0f172a;font-weight:700}
.dark .input{background:#0a1222;color:#e5e7eb;border-color:#1f2b40}
input[type="date"], input[type="time"]{direction:ltr;text-align:center}
.pill{align-self:end;padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;color:#0f172a;font-size:13px;font-weight:700;text-align:center}
.dark .pill{background:#0a1222;color:#e5e7eb;border-color:#1f2b40}

/* Time grid */
.time-grid{display:grid;grid-template-columns:1fr 1fr 160px;gap:12px}
@media (max-width:600px){.time-grid{grid-template-columns:1fr 1fr}.break-col{grid-column:1 / -1}}
.time-box{border:1px solid var(--line);background:#fff;border-radius:16px;padding:12px}
.dark .time-box{background:#0e1528;border-color:#1f2b40}
.time-box .title{display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:6px}
.start .title{color:var(--ok)} .end .title{color:var(--warn)}
.time-box input{width:100%;height:46px;padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff;color:#0f172a;font-weight:700}
.dark .time-box input{background:#0a1222;color:#e5e7eb;border-color:#1f2b40}
.start input{border-color:#86efac;background:#ecfdf5}
.end input{border-color:#fecaca;background:#fef2f2}
.dark .start input{border-color:#14532d;background:rgba(22,163,74,.08)}
.dark .end input{border-color:#7f1d1d;background:rgba(239,68,68,.08)}

/* KPIs */
.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:12px;margin-top:10px}
.kcard{border:1px solid var(--line);background:#fff;border-radius:14px;padding:12px;text-align:center}
.dark .kcard{background:#0a1222;border-color:#1f2b40;color:#e5e7eb}
.kcard h3{margin:0;color:var(--muted);font-size:13px}
.kcard .val{font-size:20px;font-weight:800;margin-top:4px}

/* Modals */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:80}
.modal.open{display:flex}
.dialog{background:var(--card);border:1px solid var(--line);border-radius:16px;max-width:920px;width:100%;padding:16px;max-height:85vh;overflow:auto;box-shadow:var(--shadow)}
.dialog h2{margin:0 0 10px;font-size:18px}
.actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
thead th{font-size:12px;color:#334155}
th,td{padding:8px 10px;text-align:center}
tbody tr{background:#fff;border:1px solid var(--line)}
.dark tbody tr{background:#0a1222;border-color:#1f2b40}
tbody td:first-child, thead th:first-child{border-radius:10px 0 0 10px}
tbody td:last-child, thead th:last-child{border-radius:0 10px 10px 0}

/* Bottom balance bar */
.bottom-bar{
  position:fixed; left:0; right:0; bottom:0; z-index:65;
  display:flex; justify-content:center;
  padding:10px 12px; border-top:1px solid var(--line);
  background:color-mix(in srgb, var(--card) 94%, transparent); backdrop-filter:blur(10px);
}
.balance-chip{
  display:inline-flex; align-items:center; gap:10px;
  padding:10px 14px; border-radius:999px; font-weight:900; letter-spacing:.2px;
  border:1px solid var(--line); background:var(--card); box-shadow:var(--shadow);
}
.badge{padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700}
.badge.ok{color:#065f46;background:rgba(16,185,129,.18);border:1px solid rgba(16,185,129,.35)}
.badge.bad{color:#7f1d1d;background:rgba(239,68,68,.18);border:1px solid rgba(239,68,68,.35)}

/* Mobile tweaks */
@media (max-width:720px){.topbar .inner{grid-template-columns:auto 1fr auto}.wrap{padding:10px}}
@media (max-width:420px){.btn{height:36px;padding:5px 10px}.wrap{margin-bottom:92px}}
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div class="inner">
    <button id="menuToggle" class="btn" aria-expanded="false">‚ò∞ Menu</button>
    <div class="brand brand-badge">‚è±Ô∏è <span id="brandTxt">Saaati</span></div>
    <div id="userPill" class="user-pill">Guest</div>
  </div>
</div>

<!-- Drawer Menu -->
<div id="menuDrawer" class="menu-drawer" aria-hidden="true">
  <div class="menu-scroller">
    <!-- Section: Navigation -->
    <div class="menu-section">
      <div class="menu-title" id="navTitle">Navigation</div>
      <div class="menu-list">
        <button id="mnuDay" class="btn">üìÖ Day</button>
        <button id="mnuMonth" class="btn">üóìÔ∏è Monthly</button>
        <button id="mnuSettings" class="btn">‚öôÔ∏è Settings</button>
        <button id="mnuExport" class="btn">üì¶ Export</button>
      </div>
    </div>

    <hr class="hr" />

    <!-- Section: Preferences -->
    <div class="menu-section">
      <div class="menu-title" id="prefTitle">Preferences</div>
      <!-- Single-line language row -->
      <div class="menu-row" id="langRow">
        <button class="lang-chip" data-lang="en" data-active="true">üåê EN</button>
        <button class="lang-chip" data-lang="ar">üåê AR</button>
        <button class="lang-chip" data-lang="de">üåê DE</button>
      </div>
      <!-- Dark mode toggle INSIDE menu -->
      <div style="display:flex;align-items:center;gap:10px;margin-top:10px">
        <label for="darkToggle" style="font-weight:700" id="lblTheme">Dark mode</label>
        <label class="switch" title="Dark mode">
          <input type="checkbox" id="darkToggle">
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <hr class="hr" />

    <!-- Section: Account -->
    <div class="menu-section">
      <div class="menu-title" id="acctTitle">Account</div>
      <div class="menu-list">
        <button id="authBtn" class="btn">Sign in</button>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- Day -->
  <div class="card" id="dayCard">
    <h1 id="titleDay">Daily Entry</h1>
    <p class="small" id="hintDay">Enter start, end and break. Autosaved locally.</p>

    <div class="date-row">
      <div class="date-input">
        <label id="lblDate">Date</label>
        <input id="dayDate" class="input" type="date" />
      </div>
      <div class="pill" id="dayName">‚Äî</div>
    </div>

    <div class="time-grid">
      <div class="time-box start">
        <div class="title" id="lblStart">üü¢ Clock In</div>
        <input id="dayStart" class="input" type="time" step="60" inputmode="numeric" />
      </div>
      <div class="time-box end">
        <div class="title" id="lblEnd">üî¥ Clock Out</div>
        <input id="dayEnd" class="input" type="time" step="60" inputmode="numeric" />
      </div>
      <div class="time-box break-col">
        <div class="title" id="lblBreak">‚òïÔ∏è Break (min)</div>
        <input id="dayBreak" class="input" type="number" min="0" step="5" value="30" />
      </div>
    </div>

    <div class="kpis">
      <div class="kcard"><h3 id="k1">Net Today</h3><div class="val" id="dNet">0:00</div></div>
      <div class="kcard"><h3 id="k2">Overtime</h3><div class="val" id="dOT">0:00</div></div>
      <div class="kcard"><h3 id="k3">Daily Base (h)</h3><div class="val" id="dBase">8</div></div>
      <div class="kcard"><h3 id="k4">Save Status</h3><div class="val" id="dSave">‚Äî</div></div>
    </div>
  </div>

  <!-- Settings -->
  <div class="card" id="settingsCard" style="display:none">
    <h1 id="titleSettings">Settings</h1>
    <p class="small" id="hintSettings">Adjust defaults.</p>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
      <div>
        <label id="lblDaily">Daily Base (hours)</label>
        <input id="stDaily" class="input" type="number" step="0.25" min="0" value="8">
      </div>
      <div>
        <label id="lblBreakDef">Default Break (min)</label>
        <input id="stBreak" class="input" type="number" step="5" min="0" value="30">
      </div>
    </div>
    <button id="applySettings" class="btn" style="margin-top:12px">Save</button>
  </div>
</div>

<!-- Month modal -->
<div id="monthModal" class="modal" aria-hidden="true">
  <div class="dialog">
    <h2 id="titleMonth">Monthly Summary</h2>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <div><label class="small" id="lblPickMonth">Pick month</label><input type="month" id="monthPick" class="input" style="height:40px"></div>
      <button id="refreshMonth" class="btn">Refresh</button>
    </div>
    <div id="monthArea" style="margin-top:12px"></div>
    <div class="kpis">
      <div class="kcard"><h3 id="mk1">Month Total</h3><div class="val" id="mTotal">0:00</div></div>
      <div class="kcard"><h3 id="mk2">Logged Days</h3><div class="val" id="mDays">0</div></div>
      <div class="kcard"><h3 id="mk3">Avg/Day</h3><div class="val" id="mAvg">0:00</div></div>
    </div>
    <div class="actions"><button id="closeMonth" class="btn">Close</button></div>
  </div>
</div>

<!-- Export modal -->
<div id="exportModal" class="modal" aria-hidden="true">
  <div class="dialog" style="max-width:520px">
    <h2 id="titleExport">Export</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <label id="lblScope">Scope</label>
        <select id="expScope" class="input" style="height:40px">
          <option value="day">Current Day</option>
          <option value="month">Selected Month</option>
        </select>
      </div>
      <div>
        <label id="lblFormat">Format</label>
        <select id="expFormat" class="input" style="height:40px">
          <option value="png">PNG</option>
          <option value="json">JSON</option>
        </select>
      </div>
    </div>
    <div class="actions">
      <button id="closeExport" class="btn">Cancel</button>
      <button id="doExport" class="btn">Export</button>
    </div>
  </div>
</div>

<!-- Bottom Balance -->
<div class="bottom-bar">
  <div class="balance-chip">
    <span id="balanceText">Balance</span>
    <span id="balanceBadge" class="badge ok">+0:00</span>
  </div>
</div>

<!-- html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous"></script>

<!-- Firebase (Auth) + App -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBpzQ4GRDzdYCuMvsj3rrWN8Ck0GLHiB2g",
  authDomain: "saaati-pro.firebaseapp.com",
  projectId: "saaati-pro",
  storageBucket: "saaati-pro.firebasestorage.app",
  messagingSenderId: "719485178559",
  appId: "1:719485178559:web:56460b57bb0560d8496c0a",
  measurementId: "G-2KBHPQP07X"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
await setPersistence(auth, browserLocalPersistence);

/* ================= I18N ================= */
const I18N = {
  ar:{dir:'rtl',brand:'ÿ≥ÿßÿπÿ™Ÿä',nav:{menu:'ÿßŸÑŸÇÿßÿ¶ŸÖÿ©',nav:'ÿßŸÑÿ™ŸÜŸÇŸÑ',day:'ÿßŸÑŸäŸàŸÖ',month:'ÿßŸÑÿ¥Ÿáÿ±Ÿä',settings:'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™',export:'ÿ™ÿµÿØŸäÿ±',pref:'ÿßŸÑÿ™ŸÅÿ∂ŸäŸÑÿßÿ™',acct:'ÿßŸÑÿ≠ÿ≥ÿßÿ®'},day:{title:'ÿßŸÑÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸäŸàŸÖŸä',hint:'ÿ£ÿØÿÆŸÑ ÿßŸÑÿ®ÿØÿßŸäÿ© ŸàÿßŸÑŸÜŸáÿßŸäÿ© ŸàÿßŸÑÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ©. ÿßŸÑÿ≠ŸÅÿ∏ ÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÖÿ≠ŸÑŸäŸãÿß.',date:'ÿ™ÿßÿ±ŸäÿÆ',start:'üü¢ ÿØÿÆŸàŸÑ',end:'üî¥ ÿÆÿ±Ÿàÿ¨',break:'‚òïÔ∏è ÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ© (ÿØŸÇŸäŸÇÿ©)',k1:'ÿµÿßŸÅŸä ÿßŸÑŸäŸàŸÖ',k2:'ÿ•ÿ∂ÿßŸÅŸä ÿßŸÑŸäŸàŸÖ',k3:'ÿ£ÿ≥ÿßÿ≥ ÿßŸÑŸäŸàŸÖ (ÿ≥)',k4:'ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ŸÅÿ∏',saved:'ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß ‚úÖ'},settings:{title:'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™',hint:'ÿßÿ∂ÿ®ÿ∑ ÿßŸÑŸÇŸäŸÖ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©.',daily:'ÿ£ÿ≥ÿßÿ≥ ÿßŸÑŸäŸàŸÖ (ÿ≥ÿßÿπÿßÿ™)',brdef:'ÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ© ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© (ÿØŸÇŸäŸÇÿ©)',apply:'ÿ≠ŸÅÿ∏'},month:{title:'ŸÖŸÑÿÆÿµ ÿ¥Ÿáÿ±Ÿä',pick:'ÿßÿÆÿ™ÿ± ÿßŸÑÿ¥Ÿáÿ±',m1:'ŸÖÿ¨ŸÖŸàÿπ ÿßŸÑÿ¥Ÿáÿ±',m2:'ÿ£ŸäÿßŸÖ ŸÖÿ≥ÿ¨ŸÑÿ©',m3:'ŸÖÿπÿØŸÑ ÿßŸÑŸäŸàŸÖ',close:'ÿ•ÿ∫ŸÑÿßŸÇ',refresh:'ÿ™ÿ≠ÿØŸäÿ´',thead:['ÿßŸÑÿ™ÿßÿ±ŸäÿÆ','ÿßŸÑÿ®ÿØÿßŸäÿ©','ÿßŸÑŸÜŸáÿßŸäÿ©','ÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ©','ÿßŸÑÿµÿßŸÅŸä','ÿ•ÿ∂ÿßŸÅŸä']},export:{title:'ÿ™ÿµÿØŸäÿ±',scope:'ÿßŸÑŸÜÿ∑ÿßŸÇ',format:'ÿßŸÑÿµŸäÿ∫ÿ©',optDay:'ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ≠ÿßŸÑŸä',optMonth:'ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑŸÖÿÆÿ™ÿßÿ±',png:'ÿµŸàÿ±ÿ© (PNG)',json:'JSON',cancel:'ÿ•ŸÑÿ∫ÿßÿ°',do:'ÿ™ÿµÿØŸäÿ±'},ui:{dark:'ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿØÿßŸÉŸÜ',balance:'ÿßŸÑÿ±ÿµŸäÿØ'}},
  en:{dir:'ltr',brand:'Saaati',nav:{menu:'Menu',nav:'Navigation',day:'Day',month:'Monthly',settings:'Settings',export:'Export',pref:'Preferences',acct:'Account'},day:{title:'Daily Entry',hint:'Enter start, end and break. Autosaved locally.',date:'Date',start:'üü¢ Clock In',end:'üî¥ Clock Out',break:'‚òïÔ∏è Break (min)',k1:'Net Today',k2:'Overtime',k3:'Daily Base (h)',k4:'Save Status',saved:'Auto-saved ‚úÖ'},settings:{title:'Settings',hint:'Adjust defaults.',daily:'Daily Base (hours)',brdef:'Default Break (min)',apply:'Save'},month:{title:'Monthly Summary',pick:'Pick month',m1:'Month Total',m2:'Logged Days',m3:'Avg/Day',close:'Close',refresh:'Refresh',thead:['Date','Start','End','Break','Net','OT']},export:{title:'Export',scope:'Scope',format:'Format',optDay:'Current Day',optMonth:'Selected Month',png:'Image (PNG)',json:'JSON',cancel:'Cancel',do:'Export'},ui:{dark:'Dark mode',balance:'Balance'}},
  de:{dir:'ltr',brand:'Meine Stunden',nav:{menu:'Men√º',nav:'Navigation',day:'Tag',month:'Monat',settings:'Einstellungen',export:'Export',pref:'Einstellungen',acct:'Konto'},day:{title:'T√§gliche Eingabe',hint:'Start, Ende und Pause. Lokal automatisch gespeichert.',date:'Datum',start:'üü¢ Einchecken',end:'üî¥ Auschecken',break:'‚òïÔ∏è Pause (Min.)',k1:'Netto heute',k2:'√úberstunden',k3:'Tages-Soll (Std)',k4:'Speicherstatus',saved:'Automatisch gespeichert ‚úÖ'},settings:{title:'Einstellungen',hint:'Standardwerte anpassen.',daily:'Tages-Soll (Std.)',brdef:'Standardpause (Min.)',apply:'Speichern'},month:{title:'Monats√ºbersicht',pick:'Monat w√§hlen',m1:'Monatssumme',m2:'Erfasste Tage',m3:'Schnitt/Tag',close:'Schlie√üen',refresh:'Aktualisieren',thead:['Datum','Start','Ende','Pause','Netto','√úSt']},export:{title:'Export',scope:'Bereich',format:'Format',optDay:'Heutiger Tag',optMonth:'Gew√§hlter Monat',png:'Bild (PNG)',json:'JSON',cancel:'Abbrechen',do:'Exportieren'},ui:{dark:'Dunkelmodus',balance:'Saldo'}}
};

/* Default language = EN */
const LS_LANG='saaati_lang';
let currentLang = localStorage.getItem(LS_LANG) || 'en';

/* Refs */
const menuToggle=document.getElementById('menuToggle');
const menuDrawer=document.getElementById('menuDrawer');
const brandTxt=document.getElementById('brandTxt');
const userPill=document.getElementById('userPill');

const navTitle=document.getElementById('navTitle');
const prefTitle=document.getElementById('prefTitle');
const acctTitle=document.getElementById('acctTitle');
const lblTheme=document.getElementById('lblTheme');

const mnuDay=document.getElementById('mnuDay');
const mnuMonth=document.getElementById('mnuMonth');
const mnuSettings=document.getElementById('mnuSettings');
const mnuExport=document.getElementById('mnuExport');
const authBtn=document.getElementById('authBtn');

const dayCard=document.getElementById('dayCard');
const settingsCard=document.getElementById('settingsCard');

const titleDay=document.getElementById('titleDay');
const hintDay=document.getElementById('hintDay');
const lblDate=document.getElementById('lblDate');
const lblStart=document.getElementById('lblStart');
const lblEnd=document.getElementById('lblEnd');
const lblBreak=document.getElementById('lblBreak');
const k1=document.getElementById('k1');
const k2=document.getElementById('k2');
const k3=document.getElementById('k3');
const k4=document.getElementById('k4');

const titleSettings=document.getElementById('titleSettings');
const hintSettings=document.getElementById('hintSettings');
const lblDaily=document.getElementById('lblDaily');
const lblBreakDef=document.getElementById('lblBreakDef');
const applySettings=document.getElementById('applySettings');

const titleMonth=document.getElementById('titleMonth');
const lblPickMonth=document.getElementById('lblPickMonth');
const refreshMonth=document.getElementById('refreshMonth');
const closeMonth=document.getElementById('closeMonth');
const monthModal=document.getElementById('monthModal');
const monthPick=document.getElementById('monthPick');
const monthArea=document.getElementById('monthArea');
const mTotal=document.getElementById('mTotal');
const mDays=document.getElementById('mDays');
const mAvg=document.getElementById('mAvg');

const titleExport=document.getElementById('titleExport');
const lblScope=document.getElementById('lblScope');
const lblFormat=document.getElementById('lblFormat');
const exportModal=document.getElementById('exportModal');
const expScope=document.getElementById('expScope');
const expFormat=document.getElementById('expFormat');
const closeExport=document.getElementById('closeExport');
const doExport=document.getElementById('doExport');

const dayDate=document.getElementById('dayDate');
const dayStart=document.getElementById('dayStart');
const dayEnd=document.getElementById('dayEnd');
const dayBreak=document.getElementById('dayBreak');
const dNet=document.getElementById('dNet');
const dOT=document.getElementById('dOT');
const dBase=document.getElementById('dBase');
const dSave=document.getElementById('dSave');
const dayName=document.getElementById('dayName');
const stDaily=document.getElementById('stDaily');
const stBreak=document.getElementById('stBreak');

/* Bottom balance */
const balanceText=document.getElementById('balanceText');
const balanceBadge=document.getElementById('balanceBadge');

/* Language chips */
const langRow=document.getElementById('langRow');
const darkToggle=document.getElementById('darkToggle');

/* Theme icon handled via switch only */
function applyDarkSwitchUI(){
  darkToggle.checked = document.body.classList.contains('dark');
}

/* Utils */
function h2m(h){if(!h)return 0; const [H,M]=h.split(':').map(Number); return H*60+(M||0);}
function m2h(m){m=Math.max(0,Math.floor(m)); const hh=Math.floor(m/60), mm=m%60; return `${hh}:${String(mm).padStart(2,'0')}`;}
function signed(m){const s=Math.sign(m); const abs=Math.abs(m); const t=`${Math.floor(abs/60)}:${String(abs%60).padStart(2,'0')}`; return (s>=0?`+${t}`:`-${t}`);}

/* Settings */
function loadSettings(){const s=JSON.parse(localStorage.getItem('settings')||'{}'); stDaily.value=s.daily??8; stBreak.value=s.break??30; dBase.textContent=String(stDaily.value);}
function saveSettings(){const s={daily:parseFloat(stDaily.value||8),break:parseInt(stBreak.value||30,10)}; localStorage.setItem('settings',JSON.stringify(s)); dBase.textContent=String(s.daily); notifySaved(); updateBalanceBar();}

/* Day */
function updateDayName(){const lang=currentLang; if(!dayDate.value){try{dayDate.valueAsDate=new Date();}catch{dayDate.value=new Date().toISOString().slice(0,10);} } try{const fmt=new Intl.DateTimeFormat(lang==='ar'?'ar-EG':lang==='de'?'de-DE':'en-GB',{weekday:'long'}); dayName.textContent=fmt.format(new Date(dayDate.value));}catch{dayName.textContent='‚Äî';}}
function compute(){const base=Math.round(parseFloat(stDaily.value||8)*60); const s=dayStart.value,e=dayEnd.value,br=Math.max(0, parseInt(dayBreak.value||0,10) || 0); if(!s||!e){dNet.textContent='0:00'; dOT.textContent='0:00'; return;} let sm=h2m(s), em=h2m(e); if(em<sm) em+=1440; const net=Math.max(0,(em-sm)-br); const ot=Math.max(0,net-base); dNet.textContent=m2h(net); dOT.textContent=m2h(ot); dBase.textContent=String(stDaily.value||8);}
function notifySaved(){const L=I18N[currentLang]; dSave.textContent=L.day.saved || 'Saved ‚úÖ'; setTimeout(()=>dSave.textContent='‚Äî',1500);}
function saveDayLocal(){const p={date:dayDate.value,start:dayStart.value,end:dayEnd.value,break:parseInt(dayBreak.value||0,10)}; localStorage.setItem('day-'+p.date,JSON.stringify(p)); notifySaved(); updateBalanceBar(); }
function loadDay(){const raw=localStorage.getItem('day-'+dayDate.value); if(raw){try{const p=JSON.parse(raw); dayStart.value=p.start||''; dayEnd.value=p.end||''; dayBreak.value=p.break??(stBreak.value||30);}catch{dayStart.value=''; dayEnd.value=''; dayBreak.value=stBreak.value||30;}} else { dayStart.value=''; dayEnd.value=''; dayBreak.value=stBreak.value||30; } compute();}

/* Month */
function buildMonthTableHead(lang){const L=I18N[lang]; const thead=monthArea.querySelector('thead'); if(thead){thead.innerHTML=`<tr>${L.month.thead.map(h=>`<th>${h}</th>`).join('')}</tr>`;}}
function openMonth(){if(!monthPick.value){monthPick.value=dayDate.value.slice(0,7);} monthModal.classList.add('open'); monthModal.setAttribute('aria-hidden','false'); refreshMonthSummary();}
function refreshMonthSummary(){const month=monthPick.value||dayDate.value.slice(0,7); const [y,mo]=month.split('-').map(Number); const first=new Date(y,mo-1,1), last=new Date(y,mo,0); const baseDay=Math.round(parseFloat(stDaily.value||8)*60); const rows=[]; let total=0, daysCount=0; for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)){const key='day-'+d.toISOString().slice(0,10); const raw=localStorage.getItem(key); if(!raw) continue; try{const p=JSON.parse(raw); if(p.start&&p.end){let sm=h2m(p.start), em=h2m(p.end); if(em<sm) em+=1440; const net=Math.max(0,(em-sm)-parseInt(p.break||0,10)); const ot=Math.max(0,net-baseDay); rows.push([key.slice(4),p.start,p.end,p.break||0,m2h(net),m2h(ot)]); total+=net; daysCount++; }}catch{}} rows.sort((a,b)=>a[0]<b[0]?-1:1); const lang=currentLang; const L=I18N[lang]; let html=`<table class="table"><thead></thead><tbody>`; rows.forEach(r=> html+=`<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td></tr>`); html+='</tbody></table>'; monthArea.innerHTML=html; monthArea.dataset.built='1'; buildMonthTableHead(lang); mTotal.textContent=m2h(total); mDays.textContent=String(daysCount); mAvg.textContent=daysCount?m2h(Math.round(total/daysCount)):'0:00'; updateBalanceBar();}

/* Export helpers */
async function nodeToPNGAndDownload(node,filename){if(typeof html2canvas==='undefined'){alert('Image export unavailable.');return;} document.body.appendChild(node); const canvas=await html2canvas(node,{scale:2,backgroundColor:'#ffffff'}); const dataURL=canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=dataURL; a.download=filename.endsWith('.png')?filename:`${filename}.png`; a.click(); node.remove();}
function langFromStorage(){ return localStorage.getItem(LS_LANG) || 'en'; }
function tsNow(){ const d=new Date(), p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`; }

/* Export */
function exportDayPNG(){
  const lang=langFromStorage(), L=I18N[lang];
  const node=document.createElement('div'); node.lang=lang; node.dir=L.dir;
  node.style.cssText='font-family: system-ui, "Noto Naskh Arabic", Tahoma; padding:16px; color:#0f172a; background:#ffffff;';
  node.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h2 style="margin:0">${L.day.title}</h2><div>${tsNow()}</div>
    </div>
    <div style="margin:6px 0">${L.day.date}: <strong>${dayDate.value}</strong></div>
    <div style="margin:6px 0">${L.day.start.replace('üü¢ ','')}: <strong>${dayStart.value||'-'}</strong>
      ‚Äî ${L.day.end.replace('üî¥ ','')}: <strong>${dayEnd.value||'-'}</strong>
      ‚Äî ${L.day.break.replace('‚òïÔ∏è ','')}: <strong>${dayBreak.value||0}</strong>
    </div>
    <div style="margin:6px 0">${L.day.k1}: <strong>${dNet.textContent}</strong>
      ‚Äî ${L.day.k2}: <strong>${dOT.textContent}</strong>
      ‚Äî ${L.settings?.daily || 'Daily Base (hours)'}: <strong>${stDaily.value}</strong></div>`;
  nodeToPNGAndDownload(node,`day-${dayDate.value}.png`);
}
function exportMonthPNG(){
  const month=monthPick.value||dayDate.value.slice(0,7);
  const [y,mo]=month.split('-').map(Number);
  const first=new Date(y,mo-1,1), last=new Date(y,mo,0);
  const baseDay=Math.round(parseFloat(stDaily.value||8)*60);
  const rows=[];
  for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)){
    const key='day-'+d.toISOString().slice(0,10);
    const raw=localStorage.getItem(key); if(!raw) continue;
    try{
      const p=JSON.parse(raw); if(!(p.start&&p.end)) continue;
      let sm=h2m(p.start), em=h2m(p.end); if(em<sm) em+=1440;
      const net=Math.max(0,(em-sm)-parseInt(p.break||0,10));
      const ot=Math.max(0,net-baseDay);
      rows.push([key.slice(4),p.start,p.end,p.break||0,m2h(net),m2h(ot)]);
    }catch{}
  }
  rows.sort((a,b)=>a[0]<b[0]?-1:1);

  const lang=langFromStorage(), L=I18N[lang];
  const node=document.createElement('div'); node.lang=lang; node.dir=L.dir;
  node.style.cssText='font-family: system-ui, "Noto Naskh Arabic", Tahoma; padding:16px; color:#0f172a; background:#ffffff; width:780px;';

  let html=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h2 style="margin:0">${L.month.title}</h2><div>${tsNow()}</div>
    </div>
    <div style="margin-bottom:8px;font-weight:700">${month}</div>
    <table style="width:100%;border-collapse:separate;border-spacing:0 8px">
      <thead><tr>${L.month.thead.map(h=>`<th style="text-align:center;color:#475569;font-size:13px">${h}</th>`).join('')}</tr></thead>
      <tbody>`;
  rows.forEach(r=>{ html+=`<tr style="background:#fff;border:1px solid #e2e8f0">
      <td style="padding:8px 10px">${r[0]}</td><td style="padding:8px 10px">${r[1]}</td>
      <td style="padding:8px 10px">${r[2]}</td><td style="padding:8px 10px">${r[3]}</td>
      <td style="padding:8px 10px">${r[4]}</td><td style="padding:8px 10px">${r[5]}</td></tr>`;});
  html+=`</tbody></table>`;

  const totalMins=rows.reduce((t,r)=>{const [h,m]=r[4].split(':').map(Number);return t+h*60+m;},0);
  const days=rows.length;
  const avgMins=days?Math.round(totalMins/days):0;
  const fmt=(m)=>`${Math.floor(m/60)}:${String(m%60).padStart(2,'0')}`;

  html+=`<div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
      <div style="border:1px solid #e2e8f0;border-radius:10px;padding:10px;min-width:200px;text-align:center">
        <div style="color:#475569;font-size:13px">${L.month.m1}</div><div style="font-size:20px;font-weight:800">${fmt(totalMins)}</div></div>
      <div style="border:1px solid #e2e8f0;border-radius:10px;padding:10px;min-width:200px;text-align:center">
        <div style="color:#475569;font-size:13px">${L.month.m2}</div><div style="font-size:20px;font-weight:800">${days}</div></div>
      <div style="border:1px solid #e2e8f0;border-radius:10px;padding:10px;min-width:200px;text-align:center">
        <div style="color:#475569;font-size:13px">${L.month.m3}</div><div style="font-size:20px;font-weight:800">${fmt(avgMins)}</div></div>
    </div>`;
  node.innerHTML=html;
  nodeToPNGAndDownload(node,`month-${month}.png`);
}
function exportDayJSON(){const lang=langFromStorage(); const data={meta:{scope:'day',lang,date:dayDate.value,exportedAt:new Date().toISOString()},payload:{date:dayDate.value,start:dayStart.value,end:dayEnd.value,break:parseInt(dayBreak.value||0,10)}}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`day-${dayDate.value}.json`; a.click(); URL.revokeObjectURL(url);}
function exportMonthJSON(){refreshMonthSummary(); const month=monthPick.value||dayDate.value.slice(0,7); const rows=[...monthArea.querySelectorAll('tbody tr')].map(tr=>[...tr.children].map(td=>td.textContent.trim())); const data={meta:{scope:'month',month,exportedAt:new Date().toISOString()},rows,totals:{total:mTotal.textContent,days:mDays.textContent,avg:mAvg.textContent}}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`month-${month}.json`; a.click(); URL.revokeObjectURL(url);}

/* Language + UI */
function setActiveLangChip(lang){
  [...langRow.querySelectorAll('.lang-chip')].forEach(ch=>{
    ch.dataset.active = (ch.dataset.lang===lang) ? 'true' : 'false';
  });
}
function setLang(lang){
  currentLang=lang;
  const L=I18N[lang]||I18N.en;
  document.documentElement.lang=lang; document.documentElement.dir=L.dir; document.body.dir=L.dir;
  brandTxt.textContent=L.brand;

  menuToggle.textContent=L.nav.menu;
  navTitle.textContent=L.nav.nav; prefTitle.textContent=L.nav.pref; acctTitle.textContent=L.nav.acct;
  mnuDay.textContent=(lang==='ar'?'üìÖ '+L.nav.day: (lang==='de'?'üìÖ '+L.nav.day:'üìÖ '+L.nav.day));
  mnuMonth.textContent='üóìÔ∏è '+L.nav.month;
  mnuSettings.textContent='‚öôÔ∏è '+L.nav.settings;
  mnuExport.textContent='üì¶ '+L.nav.export;
  lblTheme.textContent=L.ui.dark;

  titleDay.textContent=L.day.title; hintDay.textContent=L.day.hint; lblDate.textContent=L.day.date; lblStart.textContent=L.day.start; lblEnd.textContent=L.day.end; lblBreak.textContent=L.day.break; k1.textContent=L.day.k1; k2.textContent=L.day.k2; k3.textContent=L.day.k3; k4.textContent=L.day.k4;
  titleSettings.textContent=L.settings.title; hintSettings.textContent=L.settings.hint; lblDaily.textContent=L.settings.daily; lblBreakDef.textContent=L.settings.brdef; applySettings.textContent=L.settings.apply;
  titleMonth.textContent=L.month.title; lblPickMonth.textContent=L.month.pick; document.getElementById('mk1').textContent=L.month.m1; document.getElementById('mk2').textContent=L.month.m2; document.getElementById('mk3').textContent=L.month.m3; refreshMonth.textContent=L.month.refresh; closeMonth.textContent=L.month.close;
  titleExport.textContent=L.export.title; lblScope.textContent=L.export.scope; lblFormat.textContent=L.export.format; expScope.options[0].text=L.export.optDay; expScope.options[1].text=L.export.optMonth; expFormat.options[0].text=L.export.png; expFormat.options[1].text=L.export.json; closeExport.textContent=L.export.cancel; doExport.textContent=L.export.do;

  balanceText.textContent=L.ui.balance;

  authBtn.textContent=(auth.currentUser?(lang==='de'?'Abmelden':lang==='ar'?'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨':'Sign out'):(lang==='de'?'Anmelden':lang==='ar'?'ÿ™ÿ≥ÿ¨ŸäŸÑ':'Sign in'));

  localStorage.setItem(LS_LANG,lang);
  setActiveLangChip(lang);
  updateDayName();
  if(monthArea.dataset.built==='1'){buildMonthTableHead(lang);}
}

/* Balance bar (sum of all (net - base) in localStorage) */
function computeBalanceMinutes(){
  const basePerDay = Math.round(parseFloat(stDaily.value||8)*60);
  let bal = 0;
  for(let i=0;i<localStorage.length;i++){
    const key = localStorage.key(i);
    if(!key||!key.startsWith('day-')) continue;
    try{
      const p = JSON.parse(localStorage.getItem(key));
      if(!(p && p.start && p.end)) continue;
      let sm=h2m(p.start), em=h2m(p.end); if(em<sm) em+=1440;
      const net=Math.max(0,(em-sm)-parseInt(p.break||0,10));
      bal += (net - basePerDay);
    }catch{}
  }
  return bal;
}
function updateBalanceBar(){
  const mins = computeBalanceMinutes();
  balanceBadge.textContent = signed(mins);
  balanceBadge.classList.toggle('ok', mins>=0);
  balanceBadge.classList.toggle('bad', mins<0);
}

/* Auth */
authBtn.onclick = () => {
  if (auth.currentUser == null) window.location.href = 'login.html';
  else signOut(auth).catch(()=>{});
};
onAuthStateChanged(auth, (user) => {
  const lang = currentLang;
  if (!user) {
    window.location.href = "login.html";
  } else {
    const name = user.displayName || user.email || 'User';
    userPill.textContent = name;
    authBtn.textContent = (lang==='de'?'Abmelden':lang==='ar'?'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨':'Sign out');
  }
});

/* Drawer + interactions */
function showCard(card){[dayCard,settingsCard].forEach(el=>el.style.display='none'); card.style.display='block';}
function openExport(){exportModal.classList.add('open'); exportModal.setAttribute('aria-hidden','false');}
function initApp(){
  if(!localStorage.getItem(LS_LANG)){ localStorage.setItem(LS_LANG,'en'); currentLang='en'; }

  // Drawer
  menuToggle.onclick=()=>{
    const willOpen=!menuDrawer.classList.contains('open');
    menuDrawer.classList.toggle('open',willOpen);
    menuDrawer.setAttribute('aria-hidden',String(!willOpen));
    menuToggle.setAttribute('aria-expanded',String(willOpen));
  };
  window.addEventListener('click',(e)=>{
    if(!menuDrawer.contains(e.target) && !menuToggle.contains(e.target)){
      menuDrawer.classList.remove('open');
      menuDrawer.setAttribute('aria-hidden','true');
      menuToggle.setAttribute('aria-expanded','false');
    }
  });
  menuDrawer.addEventListener('click',e=>e.stopPropagation());

  // Language chips
  langRow.querySelectorAll('.lang-chip').forEach(ch=>{
    ch.addEventListener('click', ()=> setLang(ch.dataset.lang));
  });

  // Dark switch
  darkToggle.addEventListener('change', ()=>{
    document.body.classList.toggle('dark', darkToggle.checked);
  });

  // Menu actions
  mnuDay.onclick=()=>{showCard(dayCard); menuDrawer.classList.remove('open');};
  mnuSettings.onclick=()=>{loadSettings(); showCard(settingsCard); menuDrawer.classList.remove('open');};
  mnuMonth.onclick=()=>{openMonth(); menuDrawer.classList.remove('open');};
  mnuExport.onclick=()=>{openExport(); menuDrawer.classList.remove('open');};

  // Inputs
  [dayStart,dayEnd,dayBreak].forEach(el=>el.addEventListener('input',()=>{compute(); saveDayLocal();}));
  dayDate.addEventListener('change',()=>{updateDayName(); loadDay(); saveDayLocal();});

  // Settings + month + export
  applySettings.addEventListener('click',()=>{saveSettings(); compute();});
  refreshMonth.addEventListener('click',()=>{refreshMonthSummary();});
  closeMonth.addEventListener('click',()=>monthModal.classList.remove('open'));
  closeExport.addEventListener('click',()=>exportModal.classList.remove('open'));
  doExport.addEventListener('click',()=>{
    if(expScope.value==='day'){ expFormat.value==='json'?exportDayJSON():exportDayPNG(); }
    else{ expFormat.value==='json'?exportMonthJSON():exportMonthPNG(); }
    exportModal.classList.remove('open');
  });

  // Init values
  try{dayDate.valueAsDate=new Date();}catch{dayDate.value=new Date().toISOString().slice(0,10);}
  setLang(currentLang);
  loadSettings();
  loadDay();
  compute();
  applyDarkSwitchUI();
  updateBalanceBar();
}
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initApp);}else{initApp();}
</script>
</body>
</html>
