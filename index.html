<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import {
    getAuth,
    setPersistence,
    browserLocalPersistence,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    GoogleAuthProvider,
    signInWithPopup,
    signInWithRedirect,
    getRedirectResult,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

  (async function main(){
    /* ===== Firebase ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyBpzQ4GRDzdYCuMvsj3rrWN8Ck0GLHiB2g",
      authDomain: "saaati-pro.firebaseapp.com",
      projectId: "saaati-pro",
      storageBucket: "saaati-pro.firebasestorage.app",
      messagingSenderId: "719485178559",
      appId: "1:719485178559:web:56460b57bb0560d8496c0a",
      measurementId: "G-2KBHPQP07X"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    try {
      await setPersistence(auth, browserLocalPersistence);
    } catch(e) {
      console.warn('setPersistence error:', e);
    }
    const providerGoogle = new GoogleAuthProvider();

    /* ===== I18N (نفس النصوص السابقة) ===== */
    const I18N = {
      en:{dir:'ltr',brand:'Saaati',title:'Sign in',subtitle:'Sign in or create an account to sync your data across devices.',
        email:'Email',password:'Password',login:'Sign in',signup:'Create new account',google:'Continue with Google',skip:'Skip for now',back:'← Back to app',
        err:{empty:'Please enter email and password.','auth/invalid-email':'Invalid email address.','auth/user-not-found':'No user found with this email.',
             'auth/wrong-password':'Incorrect password.','auth/weak-password':'Password should be at least 6 characters.',
             'auth/popup-blocked':'Popup was blocked. Trying redirect...','auth/popup-closed-by-user':'Popup closed. Trying redirect...',
             'auth/unauthorized-domain':'This domain is not authorized in Firebase.',default:'Unexpected error: '}},
      ar:{dir:'rtl',brand:'ساعتي',title:'تسجيل الدخول',subtitle:'سجّل دخولك أو أنشئ حسابًا جديدًا لمزامنة بياناتك عبر الأجهزة.',
        email:'البريد الإلكتروني',password:'كلمة المرور',login:'دخول',signup:'إنشاء حساب جديد',google:'دخول باستخدام Google',skip:'تخطي الآن',back:'← العودة للتطبيق',
        err:{empty:'يرجى إدخال البريد وكلمة المرور.','auth/invalid-email':'بريد إلكتروني غير صالح.','auth/user-not-found':'لا يوجد مستخدم بهذا البريد.',
             'auth/wrong-password':'كلمة المرور غير صحيحة.','auth/weak-password':'كلمة المرور يجب أن تكون 6 أحرف على الأقل.',
             'auth/popup-blocked':'تم حظر النافذة المنبثقة. سيُجرّب التحويل...','auth/popup-closed-by-user':'تم إغلاق النافذة. سيُجرّب التحويل...',
             'auth/unauthorized-domain':'هذا النطاق غير مصرّح به في Firebase.',default:'خطأ غير متوقع: '}},
      de:{dir:'ltr',brand:'Meine Stunden',title:'Anmelden',subtitle:'Melde dich an oder erstelle ein Konto, um deine Daten zu synchronisieren.',
        email:'E-Mail',password:'Passwort',login:'Anmelden',signup:'Neues Konto erstellen',google:'Mit Google fortfahren',skip:'Jetzt überspringen',back:'← Zur App',
        err:{empty:'Bitte E-Mail und Passwort eingeben.','auth/invalid-email':'Ungültige E-Mail-Adresse.','auth/user-not-found':'Kein Benutzer mit dieser E-Mail gefunden.',
             'auth/wrong-password':'Falsches Passwort.','auth/weak-password':'Passwort muss mind. 6 Zeichen haben.',
             'auth/popup-blocked':'Popup blockiert. Redirect wird versucht...','auth/popup-closed-by-user':'Popup geschlossen. Redirect wird versucht...',
             'auth/unauthorized-domain':'Diese Domain ist in Firebase nicht autorisiert.',default:'Unerwarteter Fehler: '}}
    };

    const LS_LANG='saaati_lang';
    let currentLang = localStorage.getItem(LS_LANG) || 'en';

    /* ===== Refs ===== */
    const themeBtn = document.getElementById('themeBtn');
    const langBtn  = document.getElementById('langBtn');
    const langMenu = document.getElementById('langMenu');
    const langLabel= document.getElementById('langLabel');

    const brandTxt = document.getElementById('brandTxt');
    const title    = document.getElementById('title');
    const subtitle = document.getElementById('subtitle');
    const lblEmail = document.getElementById('lblEmail');
    const lblPassword = document.getElementById('lblPassword');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn= document.getElementById('signupBtn');
    const googleBtn= document.getElementById('googleBtn');
    const btnGoogleText = document.getElementById('btnGoogleText');
    const skipBtn  = document.getElementById('skipBtn');
    const backToApp= document.getElementById('backToApp');

    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const errorBox = document.getElementById('errorBox');

    /* ===== Theme ===== */
    function setThemeIcon(){
      const isDark = document.body.classList.contains('dark');
      themeBtn.textContent = isDark ? '☀️' : '🌙';
      themeBtn.setAttribute('aria-label', isDark ? 'Switch to Light' : 'Switch to Dark');
    }
    themeBtn.onclick = ()=>{ document.body.classList.toggle('dark'); setThemeIcon(); };

    /* ===== Lang ===== */
    function updateLangLabel(){ langLabel.textContent = (currentLang==='ar'?'AR': currentLang==='de'?'DE':'EN'); }
    function tErr(code){ const L=I18N[currentLang]||I18N.en; return L.err[code] || (L.err.default + code); }
    function setLang(lang){
      currentLang=lang; const L=I18N[lang]||I18N.en;
      document.documentElement.lang=lang; document.documentElement.dir=L.dir; document.body.dir=L.dir;
      brandTxt.textContent=L.brand; title.textContent=L.title; subtitle.textContent=L.subtitle;
      lblEmail.textContent=L.email; lblPassword.textContent=L.password;
      loginBtn.textContent=L.login; signupBtn.textContent=L.signup; btnGoogleText.textContent=L.google;
      skipBtn.textContent=L.skip; backToApp.textContent=L.back;
      localStorage.setItem(LS_LANG,lang); updateLangLabel(); setThemeIcon();
    }
    langBtn.addEventListener('click',(e)=>{ e.stopPropagation(); const willOpen=!langMenu.classList.contains('open'); langMenu.classList.toggle('open',willOpen); langBtn.setAttribute('aria-expanded',String(willOpen)); });
    langMenu.addEventListener('click',(e)=>e.stopPropagation());
    window.addEventListener('click',()=>{ langMenu.classList.remove('open'); langBtn.setAttribute('aria-expanded','false'); });
    window.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ langMenu.classList.remove('open'); langBtn.setAttribute('aria-expanded','false'); }});
    langMenu.querySelectorAll('.lang-opt').forEach(opt=>{
      opt.addEventListener('click', ()=>{
        const lang=opt.dataset.lang; setLang(lang);
        langMenu.querySelectorAll('.lang-opt').forEach(o=>o.dataset.active=(o.dataset.lang===lang)?'true':'false');
        langMenu.classList.remove('open'); langBtn.setAttribute('aria-expanded','false');
      });
    });

    /* ===== Errors UI ===== */
    function showError(msg){
      errorBox.textContent = msg;
      errorBox.style.display = 'block';
      setTimeout(()=> errorBox.style.display='none', 5000);
    }
    function requireFields(){
      if(!emailInput.value.trim() || !passwordInput.value.trim()){
        showError(tErr('empty')); return false;
      }
      return true;
    }

    /* ===== Auth actions ===== */
    loginBtn.addEventListener('click', async ()=>{
      try{
        if(!requireFields()) return;
        await signInWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value.trim());
        window.location.href='index.html';
      }catch(err){ showError(tErr(err.code)); console.error(err); }
    });

    signupBtn.addEventListener('click', async ()=>{
      try{
        if(!requireFields()) return;
        await createUserWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value.trim());
        window.location.href='index.html';
      }catch(err){ showError(tErr(err.code)); console.error(err); }
    });

    googleBtn.addEventListener('click', async ()=>{
      try{
        await signInWithPopup(auth, providerGoogle);
        window.location.href='index.html';
      }catch(err){
        if(err?.code==='auth/popup-blocked' || err?.code==='auth/popup-closed-by-user'){
          showError(tErr(err.code));
          try{
            await signInWithRedirect(auth, providerGoogle);
          }catch(e2){ showError(tErr(e2.code)); console.error(e2); }
        }else{
          showError(tErr(err.code)); console.error(err);
        }
      }
    });

    // Redirect result (fallback)
    try{
      const result = await getRedirectResult(auth);
      if(result && result.user){ window.location.href='index.html'; }
    }catch(err){ showError(tErr(err.code)); console.error(err); }

    skipBtn.addEventListener('click', ()=>{ window.location.href='index.html'; });

    // لو المستخدم داخل أساساً
    onAuthStateChanged(auth, (user)=>{ if(user) window.location.href='index.html'; });

    // Init
    if(!localStorage.getItem(LS_LANG)){ localStorage.setItem(LS_LANG,'en'); currentLang='en'; }
    setLang(currentLang); setThemeIcon();
  })();
</script>
