<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<title>Saaati ‚Äî Home</title>
<style>
:root{
  --bg:#f6f8fb;--card:#fff;--ink:#0f172a;--muted:#475569;--line:#e2e8f0;--ok:#16a34a;--warn:#ef4444;--accent:#3b82f6;--shadow:0 12px 30px rgba(15,23,42,.08);
}
.dark{--bg:#0b1020;--card:#0e1528;--ink:#e5e7eb;--muted:#94a3b8;--line:#1f2b40;--accent:#60a5fa;--shadow:0 18px 40px rgba(0,0,0,.4)}
*{box-sizing:border-box}
body{
  margin:0;
  background:
    radial-gradient(1200px 600px at 10% -10%,rgba(59,130,246,.08),transparent),
    radial-gradient(1000px 600px at 110% -20%,rgba(22,163,74,.08),transparent),
    var(--bg);
  color:var(--ink);
  font-family:system-ui,"Noto Naskh Arabic","Cairo",Tahoma,Arial,sans-serif
}

/* Topbar */
.topbar{position:sticky;top:0;z-index:60;background:color-mix(in srgb, var(--card) 92%, transparent);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
.dark .topbar{background:#0c1426cc}
.topbar .inner{max-width:1080px;margin:0 auto;padding:10px 14px;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;min-height:56px}
.brand{font-weight:900;display:flex;align-items:center;gap:8px;white-space:nowrap;letter-spacing:.3px}
.brand-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:12px;background:var(--card);box-shadow:var(--shadow)}
.btn{height:38px;padding:6px 12px;border-radius:12px;border:1px solid var(--line);background:var(--card);color:var(--ink);cursor:pointer}
.user-pill{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:var(--card);white-space:nowrap;max-width:32ch;overflow:hidden;text-overflow:ellipsis;box-shadow:var(--shadow)}

/* Drawer */
.menu-drawer{
  position:fixed; top:56px; bottom:0; left:0; width:320px;
  background:var(--card); border-inline-start:1px solid var(--line);
  box-shadow:var(--shadow); transform:translateX(-100%); transition:transform .25s ease; z-index:70;
}
.menu-drawer.open{transform:translateX(0)}
[dir="rtl"] .menu-drawer{left:auto; right:0; transform:translateX(100%)}
[dir="rtl"] .menu-drawer.open{transform:translateX(0)}
.menu-scroller{height:100%; overflow:auto; padding:14px}
.menu-section{margin:8px 0 14px}
.menu-title{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin:0 0 8px}
.menu-row{display:flex;gap:8px;flex-wrap:wrap}
.menu-list{display:grid;gap:8px}
.hr{height:1px;background:var(--line);border:0;margin:12px 0}

/* Lang row */
.lang-chip{padding:8px 10px;border:1px solid var(--line);background:var(--card);border-radius:999px;cursor:pointer;font-weight:700}
.lang-chip[data-active="true"]{border-color:color-mix(in srgb, var(--accent) 40%, transparent);outline:2px solid color-mix(in srgb, var(--accent) 18%, transparent)}

/* Dark switch inside menu */
.switch{position:relative;display:inline-block;width:52px;height:28px}
.switch input{display:none}
.slider{position:absolute;inset:0;border-radius:999px;background:#cbd5e1;transition:.2s}
.slider::before{
  content:"üåô"; position:absolute; inset:2px auto auto 2px;
  width:24px;height:24px;display:flex;align-items:center;justify-content:center;
  background:#fff;border-radius:50%; transition:.2s; font-size:14px;
}
input:checked + .slider{background:#60a5fa}
input:checked + .slider::before{content:"‚òÄÔ∏è"; transform:translateX(24px)}

/* Layout */
.wrap{max-width:980px;margin:18px auto 110px;padding:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
h1{margin:0 0 8px;font-size:22px}
p.small{color:var(--muted);margin:0 0 12px}

/* Inputs */
.date-row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end;margin-bottom:8px}
.date-input label{display:block;color:var(--muted);font-size:13px;margin:0 0 4px}
.input{width:100%;height:46px;padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff;color:#0f172a;font-weight:700}
.dark .input{background:#0a1222;color:#e5e7eb;border-color:#1f2b40}
input[type="date"], input[type="time"]{direction:ltr;text-align:center}
.pill{align-self:end;padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;color:#0f172a;font-size:13px;font-weight:700;text-align:center}
.dark .pill{background:#0a1222;color:#e5e7eb;border-color:#1f2b40}

/* Time grid */
.time-grid{display:grid;grid-template-columns:1fr 1fr 160px;gap:12px}
@media (max-width:600px){.time-grid{grid-template-columns:1fr 1fr}.break-col{grid-column:1 / -1}}
.time-box{border:1px solid var(--line);background:#fff;border-radius:16px;padding:12px}
.dark .time-box{background:#0e1528;border-color:#1f2b40}
.time-box .title{display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:6px}
.start .title{color:var(--ok)} .end .title{color:var(--warn)}
.time-box input{width:100%;height:46px;padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff;color:#0f172a;font-weight:700}
.dark .time-box input{background:#0a1222;color:#e5e7eb;border-color:#1f2b40}
.start input{border-color:#86efac;background:#ecfdf5}
.end input{border-color:#fecaca;background:#fef2f2}
.dark .start input{border-color:#14532d;background:rgba(22,163,74,.08)}
.dark .end input{border-color:#7f1d1d;background:rgba(239,68,68,.08)}

/* KPIs */
.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:12px;margin-top:10px}
.kcard{border:1px solid var(--line);background:#fff;border-radius:14px;padding:12px;text-align:center}
.dark .kcard{background:#0a1222;border-color:#1f2b40;color:#e5e7eb}
.kcard h3{margin:0;color:var(--muted);font-size:13px}
.kcard .val{font-size:20px;font-weight:800;margin-top:4px}
.val-pos{color:#16a34a}
.val-neg{color:#ef4444}

/* Day annotations (status + notes) */
.annot-grid{display:grid;grid-template-columns:1fr 2fr;gap:12px;margin-top:12px}
@media (max-width:720px){.annot-grid{grid-template-columns:1fr}}
.form-field label{display:block;color:var(--muted);font-size:13px;margin:0 0 6px}
.select, .textarea{width:100%;border:1px solid var(--line);border-radius:12px;background:#fff;color:#0f172a;padding:10px}
.textarea{min-height:70px;resize:vertical}
.dark .select, .dark .textarea{background:#0a1222;color:#e5e7eb;border-color:#1f2b40}

/* Modals (month/export) */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:80}
.modal.open{display:flex}
.dialog{background:var(--card);border:1px solid var(--line);border-radius:16px;max-width:920px;width:100%;padding:16px;max-height:85vh;overflow:auto;box-shadow:var(--shadow)}
.dialog h2{margin:0 0 10px;font-size:18px}
.actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
thead th{font-size:12px;color:#334155}
th,td{padding:8px 10px;text-align:center}
tbody tr{background:#fff;border:1px solid var(--line)}
.dark tbody tr{background:#0a1222;border-color:#1f2b40}
tbody td:first-child, thead th:first-child{border-radius:10px 0 0 10px}
tbody td:last-child, thead th:last-child{border-radius:0 10px 10px 0}

/* Notes table inside month modal */
.note-table th{font-size:12px;color:#334155}
.note-table td, .note-table th{padding:8px 10px;text-align:start}
.badge-note{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#f8fafc;font-weight:700;font-size:12px}
.dark .badge-note{background:#0e1528;border-color:#1f2b40;color:#e5e7eb}

/* Bottom balance bar */
.bottom-bar{
  position:fixed; left:0; right:0; bottom:0; z-index:65;
  display:flex; justify-content:center;
  padding:10px 12px; border-top:1px solid var(--line);
  background:color-mix(in srgb, var(--card) 94%, transparent); backdrop-filter:blur(10px);
}
.balance-chip{
  display:inline-flex; align-items:center; gap:10px;
  padding:10px 14px; border-radius:999px; font-weight:900; letter-spacing:.2px;
  border:1px solid var(--line); background:var(--card); box-shadow:var(--shadow);
}
.badge{padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700}
.badge.ok{color:#065f46;background:rgba(16,185,129,.18);border:1px solid rgba(16,185,129,.35)}
.badge.bad{color:#7f1d1d;background:rgba(239,68,68,.18);border:1px solid rgba(239,68,68,.35)}
.balance-btn{height:32px;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:var(--card);cursor:pointer}

/* Toast */
.toast{
  position: fixed; right:16px; top:16px; z-index:120;
  background: var(--card); color: var(--ink);
  border:1px solid var(--line); border-radius:12px; padding:10px 12px;
  box-shadow: var(--shadow); opacity:0; transform: translateY(-6px); pointer-events:none;
  transition: .25s ease;
}
.toast.show{ opacity:1; transform: translateY(0) }

/* Confirm Save Modal (new) */
.confirm-dialog{max-width:520px}
.confirm-body{color:var(--muted);line-height:1.5}
.btn-primary{background:#3b82f6;color:#fff;border-color:#3b82f6}
.btn-danger{background:#f3f4f6;color:#0f172a}

/* Animations */
.card, .dialog, .menu-drawer{transition: box-shadow .25s ease, transform .25s ease, background .25s ease, border-color .25s ease;}
@media (prefers-reduced-motion: no-preference){
  .card{ animation: fadeUp .25s ease both; }
  .menu-drawer.open{ animation: slideIn .22s ease both; }
}
@keyframes fadeUp{ from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)} }
@keyframes slideIn{ from{transform:translateX(-100%)} to{transform:translateX(0)} }
[dir="rtl"] @keyframes slideIn{ from{transform:translateX(100%)} to{transform:translateX(0)} }

:focus-visible{
  outline: 2px solid color-mix(in srgb, var(--accent) 65%, white);
  outline-offset: 2px;
  border-radius: 12px;
}

/* Mobile */
@media (max-width:720px){.topbar .inner{grid-template-columns:auto 1fr auto}.wrap{padding:10px}}
@media (max-width:420px){.btn{height:36px;padding:5px 10px}.wrap{margin-bottom:110px}}
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div class="inner">
    <button id="menuToggle" class="btn" aria-expanded="false">‚ò∞ Menu</button>
    <div class="brand brand-badge">‚è±Ô∏è <span id="brandTxt">Saaati</span></div>
    <div id="userPill" class="user-pill">Guest</div>
  </div>
</div>

<!-- Drawer Menu -->
<div id="menuDrawer" class="menu-drawer" aria-hidden="true">
  <div class="menu-scroller">
    <div class="menu-section">
      <div class="menu-title" id="navTitle">Navigation</div>
      <div class="menu-list">
        <button id="mnuDay" class="btn">üìÖ Day</button>
        <button id="mnuMonth" class="btn">üóìÔ∏è Monthly</button>
        <button id="mnuSettings" class="btn">‚öôÔ∏è Settings</button>
        <button id="mnuExport" class="btn">üì¶ Export</button>
      </div>
    </div>

    <hr class="hr" />

    <div class="menu-section">
      <div class="menu-title" id="prefTitle">Preferences</div>
      <div class="menu-row" id="langRow">
        <button class="lang-chip" data-lang="en" data-active="true">üåê EN</button>
        <button class="lang-chip" data-lang="ar">üåê AR</button>
        <button class="lang-chip" data-lang="de">üåê DE</button>
      </div>
      <div style="display:flex;align-items:center;gap:10px;margin-top:10px">
        <label for="darkToggle" style="font-weight:700" id="lblTheme">Dark mode</label>
        <label class="switch" title="Dark mode">
          <input type="checkbox" id="darkToggle">
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <hr class="hr" />

    <div class="menu-section">
      <div class="menu-title" id="acctTitle">Account</div>
      <div class="menu-list">
        <button id="authBtn" class="btn">Sign in</button>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- Day -->
  <div class="card" id="dayCard">
    <h1 id="titleDay">Daily Entry</h1>
    <p class="small" id="hintDay">Enter start, end and break. Autosaved locally.</p>

    <div class="date-row">
      <div class="date-input">
        <label id="lblDate">Date</label>
        <input id="dayDate" class="input" type="date" />
      </div>
      <div class="pill" id="dayName">‚Äî</div>
    </div>

    <div class="time-grid">
      <div class="time-box start">
        <div class="title" id="lblStart">üü¢ Clock In</div>
        <input id="dayStart" class="input" type="time" step="60" inputmode="numeric" />
      </div>
      <div class="time-box end">
        <div class="title" id="lblEnd">üî¥ Clock Out</div>
        <input id="dayEnd" class="input" type="time" step="60" inputmode="numeric" />
      </div>
      <div class="time-box break-col">
        <div class="title" id="lblBreak">‚òïÔ∏è Break (min)</div>
        <input id="dayBreak" class="input" type="number" min="0" step="5" value="30" />
      </div>
    </div>

    <!-- Annotations -->
    <div class="annot-grid">
      <div class="form-field">
        <label id="lblStatus">Day Status</label>
        <select id="dayStatus" class="select">
          <option value="work" selected>Work</option>
          <option value="vacation">Vacation</option>
          <option value="sick">Sick</option>
          <option value="absent">Absent (Other)</option>
        </select>
      </div>
      <div class="form-field" id="reasonWrap" style="display:none">
        <label id="lblReason">Reason / Note</label>
        <input id="dayReason" class="select" placeholder="Reason for absence..." />
      </div>
      <div class="form-field" style="grid-column:1 / -1">
        <label id="lblTaskNote">Task Note (what you did)</label>
        <textarea id="taskNote" class="textarea" placeholder="Brief note about tasks completed today..."></textarea>
      </div>
    </div>

    <div class="kpis">
      <div class="kcard"><h3 id="k1">Net Today</h3><div class="val" id="dNet">0:00</div></div>
      <div class="kcard"><h3 id="k2">Overtime</h3><div class="val" id="dOT">0:00</div></div>
      <div class="kcard"><h3 id="k3">Daily Base (h)</h3><div class="val" id="dBase">8</div></div>
      <!-- Replaced Save Status with Balance KPI -->
      <div class="kcard"><h3 id="k4">Balance</h3><div class="val" id="kBalance">+0:00</div></div>
    </div>
  </div>

  <!-- Settings -->
  <div class="card" id="settingsCard" style="display:none">
    <h1 id="titleSettings">Settings</h1>
    <p class="small" id="hintSettings">Adjust defaults.</p>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
      <div>
        <label id="lblDaily">Daily Base (hours)</label>
        <input id="stDaily" class="input" type="number" step="0.25" min="0" value="8">
      </div>
      <div>
        <label id="lblBreakDef">Default Break (min)</label>
        <input id="stBreak" class="input" type="number" step="5" min="0" value="30">
      </div>
    </div>
    <button id="applySettings" class="btn" style="margin-top:12px">Save</button>
  </div>
</div>

<!-- Month modal -->
<div id="monthModal" class="modal" aria-hidden="true">
  <div class="dialog">
    <h2 id="titleMonth">Monthly Summary</h2>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <div><label class="small" id="lblPickMonth">Pick month</label><input type="month" id="monthPick" class="input" style="height:40px"></div>
      <button id="refreshMonth" class="btn">Refresh</button>
    </div>
    <div id="monthArea" style="margin-top:12px"></div>

    <div id="notesArea" style="margin-top:16px"></div>

    <div class="kpis">
      <div class="kcard"><h3 id="mk1">Month Total</h3><div class="val" id="mTotal">0:00</div></div>
      <div class="kcard"><h3 id="mk2">Logged Days</h3><div class="val" id="mDays">0</div></div>
      <div class="kcard"><h3 id="mk3">Avg/Day</h3><div class="val" id="mAvg">0:00</div></div>
    </div>
    <div class="actions"><button id="closeMonth" class="btn">Close</button></div>
  </div>
</div>

<!-- Export modal -->
<div id="exportModal" class="modal" aria-hidden="true">
  <div class="dialog" style="max-width:620px">
    <h2 id="titleExport">Export</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div>
        <label id="lblScope">Scope</label>
        <select id="expScope" class="input" style="height:40px">
          <option value="day">Day</option>
          <option value="month">Month</option>
          <option value="biweek">Two Weeks</option>
        </select>
      </div>
      <div>
        <label id="lblFormat">Format</label>
        <select id="expFormat" class="input" style="height:40px">
          <option value="png">Image (PNG)</option>
          <option value="json">JSON</option>
        </select>
      </div>
      <div>
        <label id="lblLang">Export Language</label>
        <select id="expLang" class="input" style="height:40px">
          <option value="en">English</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
          <option value="de">Deutsch</option>
        </select>
      </div>
      <div id="biweekWrap" style="display:none">
        <label id="lblBwStart">Two Weeks Start</label>
        <input id="bwStart" type="date" class="input" />
      </div>
    </div>

    <div class="actions" style="margin-top:10px">
      <button id="closeExport" class="btn">Cancel</button>
      <button id="doExport" class="btn">Export</button>
    </div>
  </div>
</div>

<!-- Confirm Save Modal (NEW) -->
<div id="confirmSaveModal" class="modal" aria-hidden="true">
  <div class="dialog confirm-dialog">
    <h2 id="csTitle">Save changes?</h2>
    <p id="csBody" class="confirm-body">You made changes. Do you want to save them?</p>
    <div class="actions">
      <button id="csCancel" class="btn btn-danger">No</button>
      <button id="csOk" class="btn btn-primary">Yes</button>
    </div>
  </div>
</div>

<!-- Bottom Balance -->
<div class="bottom-bar">
  <div class="balance-chip">
    <span id="balanceText">Balance</span>
    <button id="balScopeBtn" class="balance-btn" title="Toggle scope">All</button>
    <span id="balanceBadge" class="badge ok">+0:00</span>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast">Saved ‚úÖ</div>

<!-- html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous"></script>

<!-- Firebase + App -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBpzQ4GRDzdYCuMvsj3rrWN8Ck0GLHiB2g",
  authDomain: "saaati-pro.firebaseapp.com",
  projectId: "saaati-pro",
  storageBucket: "saaati-pro.firebasestorage.app",
  messagingSenderId: "719485178559",
  appId: "1:719485178559:web:56460b57bb0560d8496c0a",
  measurementId: "G-2KBHPQP07X"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
await setPersistence(auth, browserLocalPersistence);

/* ================= I18N ================= */
const I18N = {
  ar:{dir:'rtl',brand:'ÿ≥ÿßÿπÿ™Ÿä',nav:{menu:'ÿßŸÑŸÇÿßÿ¶ŸÖÿ©',nav:'ÿßŸÑÿ™ŸÜŸÇŸÑ',day:'ÿßŸÑŸäŸàŸÖ',month:'ÿßŸÑÿ¥Ÿáÿ±Ÿä',settings:'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™',export:'ÿ™ÿµÿØŸäÿ±',pref:'ÿßŸÑÿ™ŸÅÿ∂ŸäŸÑÿßÿ™',acct:'ÿßŸÑÿ≠ÿ≥ÿßÿ®'},day:{title:'ÿßŸÑÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸäŸàŸÖŸä',hint:'ÿ£ÿØÿÆŸÑ ÿßŸÑÿ®ÿØÿßŸäÿ© ŸàÿßŸÑŸÜŸáÿßŸäÿ© ŸàÿßŸÑÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ©. ÿßŸÑÿ≠ŸÅÿ∏ ÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÖÿ≠ŸÑŸäŸãÿß.',date:'ÿ™ÿßÿ±ŸäÿÆ',start:'üü¢ ÿØÿÆŸàŸÑ',end:'üî¥ ÿÆÿ±Ÿàÿ¨',break:'‚òïÔ∏è ÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ© (ÿØŸÇŸäŸÇÿ©)',k1:'ÿµÿßŸÅŸä ÿßŸÑŸäŸàŸÖ',k2:'ÿ•ÿ∂ÿßŸÅŸä ÿßŸÑŸäŸàŸÖ',k3:'ÿ£ÿ≥ÿßÿ≥ ÿßŸÑŸäŸàŸÖ (ÿ≥)'},settings:{title:'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™',hint:'ÿßÿ∂ÿ®ÿ∑ ÿßŸÑŸÇŸäŸÖ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©.',daily:'ÿ£ÿ≥ÿßÿ≥ ÿßŸÑŸäŸàŸÖ (ÿ≥ÿßÿπÿßÿ™)',brdef:'ÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ© ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© (ÿØŸÇŸäŸÇÿ©)',apply:'ÿ≠ŸÅÿ∏'},month:{title:'ŸÖŸÑÿÆÿµ ÿ¥Ÿáÿ±Ÿä',pick:'ÿßÿÆÿ™ÿ± ÿßŸÑÿ¥Ÿáÿ±',m1:'ŸÖÿ¨ŸÖŸàÿπ ÿßŸÑÿ¥Ÿáÿ±',m2:'ÿ£ŸäÿßŸÖ ŸÖÿ≥ÿ¨ŸÑÿ©',m3:'ŸÖÿπÿØŸÑ ÿßŸÑŸäŸàŸÖ',close:'ÿ•ÿ∫ŸÑÿßŸÇ',refresh:'ÿ™ÿ≠ÿØŸäÿ´',thead:['ÿßŸÑÿ™ÿßÿ±ŸäÿÆ','ÿßŸÑÿ®ÿØÿßŸäÿ©','ÿßŸÑŸÜŸáÿßŸäÿ©','ÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ©','ÿßŸÑÿµÿßŸÅŸä','ÿ•ÿ∂ÿßŸÅŸä'],notesTitle:'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™',notesHead:['ÿßŸÑÿ™ÿßÿ±ŸäÿÆ','ÿßŸÑÿ≠ÿßŸÑÿ©','ÿ≥ÿ®ÿ® / ŸÖŸÑÿßÿ≠ÿ∏ÿ©','ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿßŸÑŸÖŸáŸÖÿ©']},export:{title:'ÿ™ÿµÿØŸäÿ±',scope:'ÿßŸÑŸÜÿ∑ÿßŸÇ',format:'ÿßŸÑÿµŸäÿ∫ÿ©',optDay:'ÿßŸÑŸäŸàŸÖ',optMonth:'ÿßŸÑÿ¥Ÿáÿ±',optBi:'ÿ£ÿ≥ÿ®ŸàÿπŸäŸÜ',png:'ÿµŸàÿ±ÿ© (PNG)',json:'JSON',cancel:'ÿ•ŸÑÿ∫ÿßÿ°',do:'ÿ™ÿµÿØŸäÿ±',lang:'ŸÑÿ∫ÿ© ÿßŸÑÿ™ÿµÿØŸäÿ±',bwStart:'ÿ®ÿØÿßŸäÿ© ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäŸÜ'},ui:{dark:'ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿØÿßŸÉŸÜ',balance:'ÿßŸÑÿ±ÿµŸäÿØ'},status:{label:'ÿ≠ÿßŸÑÿ© ÿßŸÑŸäŸàŸÖ',vals:{work:'ÿπŸÖŸÑ',vacation:'ÿ•ÿ¨ÿßÿ≤ÿ©',sick:'ŸÖÿ±ÿ∂',absent:'ÿ∫Ÿäÿßÿ®'},reason:'ÿ≥ÿ®ÿ® / ŸÖŸÑÿßÿ≠ÿ∏ÿ©',task:'ŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸÖŸáŸÖÿ©'},confirm:{title:'ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ÿü',body:'ŸÇŸÖÿ™ ÿ®ÿ•ÿ¨ÿ±ÿßÿ° ÿ™ÿπÿØŸäŸÑÿßÿ™. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ŸÅÿ∏Ÿáÿßÿü',yes:'ŸÜÿπŸÖ',no:'ŸÑÿß'}},
  en:{dir:'ltr',brand:'Saaati',nav:{menu:'Menu',nav:'Navigation',day:'Day',month:'Monthly',settings:'Settings',export:'Export',pref:'Preferences',acct:'Account'},day:{title:'Daily Entry',hint:'Enter start, end and break. Autosaved locally.',date:'Date',start:'üü¢ Clock In',end:'üî¥ Clock Out',break:'‚òïÔ∏è Break (min)',k1:'Net Today',k2:'Overtime',k3:'Daily Base (h)'},settings:{title:'Settings',hint:'Adjust defaults.',daily:'Daily Base (hours)',brdef:'Default Break (min)',apply:'Save'},month:{title:'Monthly Summary',pick:'Pick month',m1:'Month Total',m2:'Logged Days',m3:'Avg/Day',close:'Close',refresh:'Refresh',thead:['Date','Start','End','Break','Net','OT'],notesTitle:'Notes',notesHead:['Date','Status','Reason / Note','Task Note']},export:{title:'Export',scope:'Scope',format:'Format',optDay:'Day',optMonth:'Month',optBi:'Two Weeks',png:'Image (PNG)',json:'JSON',cancel:'Cancel',do:'Export',lang:'Export Language',bwStart:'Two Weeks Start'},ui:{dark:'Dark mode',balance:'Balance'},status:{label:'Day Status',vals:{work:'Work',vacation:'Vacation',sick:'Sick',absent:'Absent (Other)'},reason:'Reason / Note',task:'Task Note'},confirm:{title:'Save changes?',body:'You made changes. Do you want to save them?',yes:'Yes',no:'No'}},
  de:{dir:'ltr',brand:'Meine Stunden',nav:{menu:'Men√º',nav:'Navigation',day:'Tag',month:'Monat',settings:'Einstellungen',export:'Export',pref:'Einstellungen',acct:'Konto'},day:{title:'T√§gliche Eingabe',hint:'Start, Ende und Pause. Lokal automatisch gespeichert.',date:'Datum',start:'üü¢ Einchecken',end:'üî¥ Auschecken',break:'‚òïÔ∏è Pause (Min.)',k1:'Netto heute',k2:'√úberstunden',k3:'Tages-Soll (Std.)'},settings:{title:'Einstellungen',hint:'Standardwerte anpassen.',daily:'Tages-Soll (Std.)',brdef:'Standardpause (Min.)',apply:'Speichern'},month:{title:'Monats√ºbersicht',pick:'Monat w√§hlen',m1:'Monatssumme',m2:'Erfasste Tage',m3:'Schnitt/Tag',close:'Schlie√üen',refresh:'Aktualisieren',thead:['Datum','Start','Ende','Pause','Netto','√úSt'],notesTitle:'Notizen',notesHead:['Datum','Status','Grund / Notiz','Aufgaben-Notiz']},export:{title:'Export',scope:'Bereich',format:'Format',optDay:'Tag',optMonth:'Monat',optBi:'Zwei Wochen',png:'Bild (PNG)',json:'JSON',cancel:'Abbrechen',do:'Exportieren',lang:'Exportsprache',bwStart:'Zwei-Wochen Start'},ui:{dark:'Dunkelmodus',balance:'Saldo'},status:{label:'Tagesstatus',vals:{work:'Arbeit',vacation:'Urlaub',sick:'Krank',absent:'Abwesend'},reason:'Grund / Notiz',task:'Aufgaben-Notiz'},confirm:{title:'√Ñnderungen speichern?',body:'Sie haben √Ñnderungen vorgenommen. M√∂chten Sie diese speichern?',yes:'Ja',no:'Nein'}}
};

const LS_LANG='saaati_lang';
let currentLang = localStorage.getItem(LS_LANG) || 'en';

/* ===== Refs ===== */
const menuToggle=document.getElementById('menuToggle');
const menuDrawer=document.getElementById('menuDrawer');
const brandTxt=document.getElementById('brandTxt');
const userPill=document.getElementById('userPill');

const navTitle=document.getElementById('navTitle');
const prefTitle=document.getElementById('prefTitle');
const acctTitle=document.getElementById('acctTitle');
const lblTheme=document.getElementById('lblTheme');

const mnuDay=document.getElementById('mnuDay');
const mnuMonth=document.getElementById('mnuMonth');
const mnuSettings=document.getElementById('mnuSettings');
const mnuExport=document.getElementById('mnuExport');
const authBtn=document.getElementById('authBtn');

const dayCard=document.getElementById('dayCard');
const settingsCard=document.getElementById('settingsCard');

const titleDay=document.getElementById('titleDay');
const hintDay=document.getElementById('hintDay');
const lblDate=document.getElementById('lblDate');
const lblStart=document.getElementById('lblStart');
const lblEnd=document.getElementById('lblEnd');
const lblBreak=document.getElementById('lblBreak');

const titleSettings=document.getElementById('titleSettings');
const hintSettings=document.getElementById('hintSettings');
const lblDaily=document.getElementById('lblDaily');
const lblBreakDef=document.getElementById('lblBreakDef');
const applySettings=document.getElementById('applySettings');

const titleMonth=document.getElementById('titleMonth');
const lblPickMonth=document.getElementById('lblPickMonth');
const refreshMonth=document.getElementById('refreshMonth');
const closeMonth=document.getElementById('closeMonth');
const monthModal=document.getElementById('monthModal');
const monthPick=document.getElementById('monthPick');
const monthArea=document.getElementById('monthArea');
const notesArea=document.getElementById('notesArea');
const mTotal=document.getElementById('mTotal');
const mDays=document.getElementById('mDays');
const mAvg=document.getElementById('mAvg');

const titleExport=document.getElementById('titleExport');
const lblScope=document.getElementById('lblScope');
const lblFormat=document.getElementById('lblFormat');
const exportModal=document.getElementById('exportModal');
const expScope=document.getElementById('expScope');
const expFormat=document.getElementById('expFormat');
const expLang=document.getElementById('expLang');
const lblLang=document.getElementById('lblLang');
const biweekWrap=document.getElementById('biweekWrap');
const bwStart=document.getElementById('bwStart');
const closeExport=document.getElementById('closeExport');
const doExport=document.getElementById('doExport');

const dayDate=document.getElementById('dayDate');
const dayStart=document.getElementById('dayStart');
const dayEnd=document.getElementById('dayEnd');
const dayBreak=document.getElementById('dayBreak');
const dayStatus=document.getElementById('dayStatus');
const dayReason=document.getElementById('dayReason');
const taskNote=document.getElementById('taskNote');
const reasonWrap=document.getElementById('reasonWrap');

/* Balance (top kpi + bottom bar) */
const k1=document.getElementById('k1');
const k2=document.getElementById('k2');
const k3=document.getElementById('k3');
const kBalance=document.getElementById('kBalance');
const dayName=document.getElementById('dayName');
const stDaily=document.getElementById('stDaily');
const stBreak=document.getElementById('stBreak');
const dNet=document.getElementById('dNet');
const dOT=document.getElementById('dOT');
const dBase=document.getElementById('dBase');

const balanceText=document.getElementById('balanceText');
const balanceBadge=document.getElementById('balanceBadge');
const balScopeBtn=document.getElementById('balScopeBtn');

const langRow=document.getElementById('langRow');
const darkToggle=document.getElementById('darkToggle');

const toast = document.getElementById('toast');

/* Confirm Save Modal refs */
const csModal = document.getElementById('confirmSaveModal');
const csTitle = document.getElementById('csTitle');
const csBody  = document.getElementById('csBody');
const csOk    = document.getElementById('csOk');
const csCancel= document.getElementById('csCancel');

/* ====== Utils ====== */
function h2m(h){if(!h)return 0; const [H,M]=h.split(':').map(Number); return H*60+(M||0);}
function m2h(m){m=Math.max(0,Math.floor(m)); const hh=Math.floor(m/60), mm=m%60; return `${hh}:${String(mm).padStart(2,'0')}`;}
function signed(m){const s=Math.sign(m); const abs=Math.abs(m); const t=`${Math.floor(abs/60)}:${String(abs%60).padStart(2,'0')}`; return (s>=0?`+${t}`:`-${t}`);}
function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'), 1200); }

/* ====== i18n ====== */
function setActiveLangChip(lang){
  [...langRow.querySelectorAll('.lang-chip')].forEach(ch=>{
    ch.dataset.active = (ch.dataset.lang===lang) ? 'true' : 'false';
  });
}
function setLang(lang){
  currentLang=lang;
  const L=I18N[lang]||I18N.en;
  document.documentElement.lang=lang; document.documentElement.dir=L.dir; document.body.dir=L.dir;
  brandTxt.textContent=L.brand;

  menuToggle.textContent=L.nav.menu;
  navTitle.textContent=L.nav.nav; prefTitle.textContent=L.nav.pref; acctTitle.textContent=L.nav.acct;
  mnuDay.textContent='üìÖ '+L.nav.day; mnuMonth.textContent='üóìÔ∏è '+L.nav.month; mnuSettings.textContent='‚öôÔ∏è '+L.nav.settings; mnuExport.textContent='üì¶ '+L.nav.export;
  lblTheme.textContent=L.ui.dark;

  titleDay.textContent=L.day.title; hintDay.textContent=L.day.hint; lblDate.textContent=L.day.date; lblStart.textContent=L.day.start; lblEnd.textContent=L.day.end; lblBreak.textContent=L.day.break;
  k1.textContent=L.day.k1; k2.textContent=L.day.k2; k3.textContent=L.day.k3;
  document.getElementById('k4').textContent = L.ui.balance;
  balanceText.textContent=L.ui.balance;

  // status labels
  document.getElementById('lblStatus')?.remove(); // ensure not duplicated
  // add labels:
  const lblStatusEl = document.createElement('label'); lblStatusEl.id='lblStatus'; lblStatusEl.textContent=L.status.label; dayStatus.parentElement.prepend(lblStatusEl);
  reasonWrap.querySelector('label').textContent=L.status.reason;
  document.getElementById('lblTaskNote').textContent=L.status.task;

  const map=L.status.vals;
  dayStatus.options[0].text=map.work; dayStatus.options[1].text=map.vacation; dayStatus.options[2].text=map.sick; dayStatus.options[3].text=map.absent;

  // confirm modal
  csTitle.textContent=L.confirm.title;
  csBody.textContent=L.confirm.body;
  csOk.textContent=L.confirm.yes;
  csCancel.textContent=L.confirm.no;

  titleSettings.textContent=L.settings.title; hintSettings.textContent=L.settings.hint; lblDaily.textContent=L.settings.daily; lblBreakDef.textContent=L.settings.brdef; applySettings.textContent=L.settings.apply;
  titleMonth.textContent=L.month.title; lblPickMonth.textContent=L.month.pick; document.getElementById('mk1').textContent=L.month.m1; document.getElementById('mk2').textContent=L.month.m2; document.getElementById('mk3').textContent=L.month.m3; refreshMonth.textContent=L.month.refresh; closeMonth.textContent=L.month.close;

  titleExport.textContent=L.export.title; lblScope.textContent=L.export.scope; lblFormat.textContent=L.export.format; expScope.options[0].text=L.export.optDay; expScope.options[1].text=L.export.optMonth; expScope.options[2].text=L.export.optBi; expFormat.options[0].text=L.export.png; expFormat.options[1].text=L.export.json; closeExport.textContent=L.export.cancel; doExport.textContent=L.export.do; lblLang.textContent=L.export.lang; document.getElementById('lblBwStart').textContent=L.export.bwStart;

  authBtn.textContent=(auth.currentUser?(lang==='de'?'Abmelden':lang==='ar'?'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨':'Sign out'):(lang==='de'?'Anmelden':lang==='ar'?'ÿ™ÿ≥ÿ¨ŸäŸÑ':'Sign in'));

  localStorage.setItem(LS_LANG,lang);
  setActiveLangChip(lang);
  updateDayName();
  if(monthArea.dataset.built==='1'){buildMonthTableHead(lang);}
}

/* ====== Settings / Compute ====== */
function loadSettings(){const s=JSON.parse(localStorage.getItem('settings')||'{}'); stDaily.value=s.daily??8; stBreak.value=s.break??30; dBase.textContent=String(stDaily.value);}
function saveSettings(){const s={daily:parseFloat(stDaily.value||8),break:parseInt(stBreak.value||30,10)}; localStorage.setItem('settings',JSON.stringify(s)); dBase.textContent=String(s.daily); showToast('Saved ‚úÖ'); updateBalanceBar();}

function updateDayName(){const lang=currentLang; if(!dayDate.value){try{dayDate.valueAsDate=new Date();}catch{dayDate.value=new Date().toISOString().slice(0,10);} } try{const fmt=new Intl.DateTimeFormat(lang==='ar'?'ar-EG':lang==='de'?'de-DE':'en-GB',{weekday:'long'}); dayName.textContent=fmt.format(new Date(dayDate.value));}catch{dayName.textContent='‚Äî';}}
function compute(){const base=Math.round(parseFloat(stDaily.value||8)*60); const s=dayStart.value,e=dayEnd.value,br=Math.max(0, parseInt(dayBreak.value||0,10) || 0); if(!s||!e){dNet.textContent='0:00'; dOT.textContent='0:00'; return;} let sm=h2m(s), em=h2m(e); if(em<sm) em+=1440; const net=Math.max(0,(em-sm)-br); const ot=Math.max(0,net-base); dNet.textContent=m2h(net); dOT.textContent=m2h(ot); dBase.textContent=String(stDaily.value||8);}

/* ====== Save/Load + Confirm flow ====== */
function captureForm(){
  return {
    date:dayDate.value,
    start:dayStart.value||'',
    end:dayEnd.value||'',
    break:parseInt(dayBreak.value||0,10),
    status:dayStatus.value||'work',
    reason:dayReason.value||'',
    taskNote:taskNote.value||''
  };
}
function fillForm(p){
  dayStart.value=p.start||'';
  dayEnd.value=p.end||'';
  dayBreak.value=p.break??(stBreak.value||30);
  dayStatus.value=p.status||'work';
  dayReason.value=p.reason||'';
  taskNote.value=p.taskNote||'';
  reasonWrap.style.display = (dayStatus.value==='work') ? 'none' : 'block';
  compute();
}

let lastSaved = null;     // snapshot of last saved data for the selected day
let confirmOpen = false;  // prevent stacking modals
let pendingChange = false;

// open confirm modal with current i18n
function openConfirm(){
  if(confirmOpen) return;
  confirmOpen=true;
  csModal.classList.add('open');
  csModal.setAttribute('aria-hidden','false');
}
function closeConfirm(){
  confirmOpen=false;
  csModal.classList.remove('open');
  csModal.setAttribute('aria-hidden','true');
}

function saveDayLocal(){
  try{
    const p=captureForm();
    localStorage.setItem('day-'+p.date,JSON.stringify(p));
    lastSaved = JSON.parse(JSON.stringify(p)); // deep copy
    showToast((currentLang==='ar'?'ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ‚úÖ': currentLang==='de'?'Gespeichert ‚úÖ':'Saved ‚úÖ'));
    updateBalanceBar();
  }catch(e){
    alert('Save error: '+e?.message);
  }
}

function loadDay(){
  const raw=localStorage.getItem('day-'+dayDate.value);
  if(raw){
    try{ lastSaved = JSON.parse(raw); fillForm(lastSaved); }
    catch{ lastSaved = captureForm(); }
  }else{
    lastSaved = {date:dayDate.value,start:'',end:'',break:parseInt(stBreak.value||30,10),status:'work',reason:'',taskNote:''};
    fillForm(lastSaved);
  }
  pendingChange=false;
}

/* ====== Month + Notes (same as ŸÇÿ®ŸÑ) ====== */
function buildMonthTableHead(lang){const L=I18N[lang]; const thead=monthArea.querySelector('thead'); if(thead){thead.innerHTML=`<tr>${L.month.thead.map(h=>`<th>${h}</th>`).join('')}</tr>`;}}
function buildNotesTable(lang, annotations){
  const L=I18N[lang];
  if(!annotations.length){ notesArea.innerHTML=''; return; }
  const head = L.month.notesHead;
  let html = `<h3 style="margin:10px 0">${L.month.notesTitle}</h3>
    <table class="table note-table"><thead><tr>${head.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>`;
  annotations.forEach(a=>{
    html += `<tr><td>${a.date}</td><td><span class="badge-note">${a.statusLabel}</span></td><td>${a.reason||'-'}</td><td>${a.taskNote||'-'}</td></tr>`;
  });
  html += `</tbody></table>`;
  notesArea.innerHTML = html;
}
function openMonth(){if(!monthPick.value){monthPick.value=dayDate.value.slice(0,7);} monthModal.classList.add('open'); monthModal.setAttribute('aria-hidden','false'); refreshMonthSummary();}
function refreshMonthSummary(){
  const month=monthPick.value||dayDate.value.slice(0,7);
  const [y,mo]=month.split('-').map(Number);
  const first=new Date(y,mo-1,1), last=new Date(y,mo,0);
  const baseDay=Math.round(parseFloat(stDaily.value||8)*60);
  const rows=[]; let total=0, daysCount=0;
  const annotations=[];
  for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)){
    const key='day-'+d.toISOString().slice(0,10);
    const raw=localStorage.getItem(key); if(!raw) continue;
    try{
      const p=JSON.parse(raw);
      if(p.start&&p.end){
        let sm=h2m(p.start), em=h2m(p.end); if(em<sm) em+=1440;
        const net=Math.max(0,(em-sm)-parseInt(p.break||0,10));
        const ot=Math.max(0,net-baseDay);
        rows.push([key.slice(4),p.start,p.end,p.break||0,m2h(net),m2h(ot)]);
        total+=net; daysCount++;
      }
      const nonWork = p.status && p.status!=='work';
      const hasTask = p.taskNote && p.taskNote.trim().length>0;
      if(nonWork || hasTask){
        const L=I18N[currentLang], map=L.status.vals;
        annotations.push({
          date:key.slice(4),
          statusLabel: (map && map[p.status||'work']) || (p.status||'work'),
          reason:p.reason||'',
          taskNote:p.taskNote||''
        });
      }
    }catch{}
  }
  rows.sort((a,b)=>a[0]<b[0]?-1:1);
  annotations.sort((a,b)=>a.date<b.date?-1:1);
  let html=`<table class="table"><thead></thead><tbody>`;
  rows.forEach(r=> html+=`<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td></tr>`);
  html+='</tbody></table>';
  monthArea.innerHTML=html;
  monthArea.dataset.built='1'; buildMonthTableHead(currentLang);
  mTotal.textContent=m2h(total); mDays.textContent=String(daysCount); mAvg.textContent=daysCount?m2h(Math.round(total/daysCount)):'0:00';
  buildNotesTable(currentLang, annotations);
  updateBalanceBar();
}

/* ====== Export (unchanged) ====== */
async function nodeToPNGAndDownload(node,filename){if(typeof html2canvas==='undefined'){alert('Image export unavailable.');return;} document.body.appendChild(node); const canvas=await html2canvas(node,{scale:2,backgroundColor:'#ffffff'}); const dataURL=canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=dataURL; a.download=filename.endsWith('.png')?filename:`${filename}.png`; a.click(); node.remove();}
function tsNow(){ const d=new Date(), p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`; }
function periodLabelFromDates(start,end){const p=n=>String(n).padStart(2,'0'); return `${start.getFullYear()}-${p(start.getMonth()+1)}-${p(start.getDate())}_to_${end.getFullYear()}-${p(end.getMonth()+1)}-${p(end.getDate())}`}

function buildDataForRange(d0, d1, basePerDay){
  const rows=[]; let total=0, daysCount=0;
  const annotations=[];
  for(let d=new Date(d0); d<=d1; d.setDate(d.getDate()+1)){
    const key='day-'+d.toISOString().slice(0,10);
    const raw=localStorage.getItem(key); if(!raw) continue;
    try{
      const p=JSON.parse(raw);
      if(p.start&&p.end){
        let sm=h2m(p.start), em=h2m(p.end); if(em<sm) em+=1440;
        const net=Math.max(0,(em-sm)-parseInt(p.break||0,10));
        const ot=Math.max(0,net-basePerDay);
        rows.push([key.slice(4),p.start,p.end,p.break||0,m2h(net),m2h(ot)]);
        total+=net; daysCount++;
      }
      const nonWork = p.status && p.status!=='work';
      const hasTask = p.taskNote && p.taskNote.trim().length>0;
      if(nonWork || hasTask){
        const lang=expLang.value, L=I18N[lang], map=L.status.vals;
        annotations.push({
          date:key.slice(4),
          statusLabel: (map && map[p.status||'work']) || (p.status||'work'),
          reason:p.reason||'',
          taskNote:p.taskNote||''
        });
      }
    }catch{}
  }
  rows.sort((a,b)=>a[0]<b[0]?-1:1);
  annotations.sort((a,b)=>a.date<b.date?-1:1);
  return {rows,total,daysCount,annotations};
}
function exportDayPNGWithLang(L){
  const node=document.createElement('div'); node.lang=expLang.value; node.dir=L.dir;
  node.style.cssText='font-family: system-ui, "Noto Naskh Arabic", Tahoma; padding:16px; color:#0f172a; background:#ffffff; width:760px;';
  let html=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h2 style="margin:0">${L.day.title}</h2><div>${tsNow()}</div>
    </div>
    <div style="margin:6px 0">${L.day.date}: <strong>${dayDate.value}</strong></div>
    <div style="margin:6px 0">${L.day.start.replace('üü¢ ','')}: <strong>${dayStart.value||'-'}</strong>
      ‚Äî ${L.day.end.replace('üî¥ ','')}: <strong>${dayEnd.value||'-'}</strong>
      ‚Äî ${L.day.break.replace('‚òïÔ∏è ','')}: <strong>${dayBreak.value||0}</strong></div>
    <div style="margin:6px 0">${L.day.k1}: <strong>${dNet.textContent}</strong>
      ‚Äî ${L.day.k2}: <strong>${dOT.textContent}</strong>
      ‚Äî ${L.settings?.daily || 'Daily Base (hours)'}: <strong>${stDaily.value}</strong></div>`;
  // status / notes
  const map=L.status?.vals;
  const statusTxt=(map && map[dayStatus.value]) || dayStatus.value;
  html += `<div style="margin:10px 0"><strong>${L.status.label}:</strong> ${statusTxt}</div>`;
  if(dayStatus.value!=='work' && dayReason.value){ html+=`<div style="margin:6px 0"><strong>${L.status.reason}:</strong> ${dayReason.value}</div>`; }
  if(taskNote.value){ html+=`<div style="margin:6px 0"><strong>${L.status.task}:</strong> ${taskNote.value}</div>`; }
  node.innerHTML=html;
  nodeToPNGAndDownload(node,`day-${dayDate.value}.png`);
}
function exportPeriodPNG(L, title, periodLabel, rows, annotations){
  const node=document.createElement('div'); node.lang=expLang.value; node.dir=L.dir;
  node.style.cssText='font-family: system-ui, "Noto Naskh Arabic", Tahoma; padding:16px; color:#0f172a; background:#ffffff; width:900px;';
  let html=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h2 style="margin:0">${title}</h2><div>${tsNow()}</div>
    </div>
    <div style="margin-bottom:8px;font-weight:700">${periodLabel}</div>
    <table style="width:100%;border-collapse:separate;border-spacing:0 8px">
      <thead><tr>${I18N[expLang.value].month.thead.map(h=>`<th style="text-align:center;color:#475569;font-size:13px">${h}</th>`).join('')}</tr></thead>
      <tbody>`;
  rows.forEach(r=>{ html+=`<tr style="background:#fff;border:1px solid #e2e8f0">
      <td style="padding:8px 10px">${r[0]}</td><td style="padding:8px 10px">${r[1]}</td>
      <td style="padding:8px 10px">${r[2]}</td><td style="padding:8px 10px">${r[3]}</td>
      <td style="padding:8px 10px">${r[4]}</td><td style="padding:8px 10px">${r[5]}</td></tr>`;});
  html+=`</tbody></table>`;
  if(annotations.length){
    const Lx=I18N[expLang.value], head=Lx.month.notesHead;
    html+=`<div style="margin-top:12px"><h3 style="margin:8px 0">${Lx.month.notesTitle}</h3>
      <table style="width:100%;border-collapse:separate;border-spacing:0 8px">
        <thead><tr>${head.map(h=>`<th style="text-align:left;color:#475569;font-size:13px">${h}</th>`).join('')}</tr></thead><tbody>`;
    annotations.forEach(a=>{
      html+=`<tr style="background:#fff;border:1px solid #e2e8f0">
        <td style="padding:8px 10px">${a.date}</td>
        <td style="padding:8px 10px">${a.statusLabel}</td>
        <td style="padding:8px 10px">${a.reason||'-'}</td>
        <td style="padding:8px 10px">${a.taskNote||'-'}</td></tr>`;
    });
    html+=`</tbody></table></div>`;
  }
  node.innerHTML=html;
  nodeToPNGAndDownload(node,`period-${periodLabel}.png`);
}
function exportDayJSONWithLang(lang){
  const data={meta:{scope:'day',lang,date:dayDate.value,exportedAt:new Date().toISOString()},
    payload:captureForm()};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`day-${dayDate.value}.json`; a.click(); URL.revokeObjectURL(url);
}
function exportRowsJSON(scopeLabel, periodLabel, rows, lang, annotations){
  const data={meta:{scope:scopeLabel,period:periodLabel,lang,exportedAt:new Date().toISOString()},rows,annotations};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`${scopeLabel}-${periodLabel}.json`; a.click(); URL.revokeObjectURL(url);
}

/* ====== Balance ====== */
let balanceScope = localStorage.getItem('balance_scope') || 'all';
function computeBalanceMinutes(scope='all'){
  const basePerDay = Math.round(parseFloat(stDaily.value||8)*60);
  let bal = 0;
  if(scope === 'month'){
    const month = monthPick.value || dayDate.value.slice(0,7);
    const [y,mo]=month.split('-').map(Number);
    const first=new Date(y,mo-1,1), last=new Date(y,mo,0);
    for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)){
      const key='day-'+d.toISOString().slice(0,10);
      const raw=localStorage.getItem(key); if(!raw) continue;
      try{
        const p=JSON.parse(raw); if(!(p.start&&p.end)) continue;
        let sm=h2m(p.start), em=h2m(p.end); if(em<sm) em+=1440;
        const net=Math.max(0,(em-sm)-parseInt(p.break||0,10));
        bal += (net - basePerDay);
      }catch{}
    }
    return bal;
  }
  for(let i=0;i<localStorage.length;i++){
    const key = localStorage.key(i);
    if(!key||!key.startsWith('day-')) continue;
    try{
      const p = JSON.parse(localStorage.getItem(key));
      if(!(p && p.start && p.end)) continue;
      let sm=h2m(p.start), em=h2m(p.end); if(em<sm) em+=1440;
      const net=Math.max(0,(em-sm)-parseInt(p.break||0,10));
      bal += (net - basePerDay);
    }catch{}
  }
  return bal;
}
function updateBalanceBar(){
  const mins = computeBalanceMinutes(balanceScope);
  const txt = signed(mins);
  balanceBadge.textContent = txt;
  balanceBadge.classList.toggle('ok', mins>=0);
  balanceBadge.classList.toggle('bad', mins<0);
  balScopeBtn.textContent = (balanceScope==='all' ? 'All' : 'Month');

  // update KPI balance
  kBalance.textContent = txt;
  kBalance.classList.toggle('val-pos', mins>=0);
  kBalance.classList.toggle('val-neg', mins<0);
}
balScopeBtn.addEventListener('click', ()=>{
  balanceScope = (balanceScope==='all'?'month':'all');
  localStorage.setItem('balance_scope', balanceScope);
  updateBalanceBar();
});
monthPick?.addEventListener('change', ()=>{ if(balanceScope==='month') updateBalanceBar(); });

/* ====== Auth ====== */
authBtn.onclick = () => {
  if (auth.currentUser == null) window.location.href = 'login.html';
  else signOut(auth).catch(()=>{});
};
onAuthStateChanged(auth, (user) => {
  const lang = currentLang;
  if (!user) {
    window.location.href = "login.html";
  } else {
    const name = user.displayName || user.email || 'User';
    userPill.textContent = name;
    authBtn.textContent = (lang==='de'?'Abmelden':lang==='ar'?'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨':'Sign out');
  }
});

/* ====== UI/Init/Events ====== */
function showCard(card){[dayCard,settingsCard].forEach(el=>el.style.display='none'); card.style.display='block';}
function openExport(){exportModal.classList.add('open'); exportModal.setAttribute('aria-hidden','false');}

function initApp(){
  if(!localStorage.getItem(LS_LANG)){ localStorage.setItem(LS_LANG,'en'); currentLang='en'; }

  // Drawer open/close
  menuToggle.onclick=()=>{
    const willOpen=!menuDrawer.classList.contains('open');
    menuDrawer.classList.toggle('open',willOpen);
    menuDrawer.setAttribute('aria-hidden',String(!willOpen));
    menuToggle.setAttribute('aria-expanded',String(willOpen));
  };
  window.addEventListener('click',(e)=>{
    if(!menuDrawer.contains(e.target) && !menuToggle.contains(e.target)){
      menuDrawer.classList.remove('open');
      menuDrawer.setAttribute('aria-hidden','true');
      menuToggle.setAttribute('aria-expanded','false');
    }
  });
  menuDrawer.addEventListener('click',e=>e.stopPropagation());

  // Language chips
  langRow.querySelectorAll('.lang-chip').forEach(ch=>{
    ch.addEventListener('click', ()=> setLang(ch.dataset.lang));
  });

  // Dark switch
  darkToggle.addEventListener('change', ()=>{
    document.body.classList.toggle('dark', darkToggle.checked);
  });

  // Menu actions
  mnuDay.onclick=()=>{showCard(dayCard); menuDrawer.classList.remove('open');};
  mnuSettings.onclick=()=>{loadSettings(); showCard(settingsCard); menuDrawer.classList.remove('open');};
  mnuMonth.onclick=()=>{openMonth(); menuDrawer.classList.remove('open');};
  mnuExport.onclick=()=>{openExport();
    expLang.value = currentLang;
    expScope.value = 'month';
    expFormat.value = 'png';
    biweekWrap.style.display = 'none';
    try{bwStart.valueAsDate = new Date();}catch{bwStart.value = new Date().toISOString().slice(0,10);}
  };
  expScope.addEventListener('change', ()=>{ biweekWrap.style.display = (expScope.value==='biweek') ? 'block' : 'none'; });

  // Inputs: open confirm on first change
  function onUserChange(){
    compute();
    pendingChange = true;
    openConfirm();
  }
  [dayStart,dayEnd,dayBreak,dayReason,taskNote].forEach(el=>{
    el.addEventListener('input', onUserChange);
  });
  dayStatus.addEventListener('change', ()=>{
    reasonWrap.style.display = (dayStatus.value==='work') ? 'none' : 'block';
    onUserChange();
  });

  // Date change = load snapshot (no confirm here)
  dayDate.addEventListener('change',()=>{ updateDayName(); loadDay(); });

  // Settings
  applySettings.addEventListener('click',()=>{saveSettings(); compute();});

  // Month / Export close
  refreshMonth.addEventListener('click', refreshMonthSummary);
  closeMonth.addEventListener('click',()=>monthModal.classList.remove('open'));
  closeExport.addEventListener('click',()=>exportModal.classList.remove('open'));

  // Confirm modal actions
  csOk.addEventListener('click', ()=>{
    saveDayLocal();
    pendingChange=false;
    closeConfirm();
  });
  csCancel.addEventListener('click', ()=>{
    // revert form to last saved snapshot
    if(lastSaved) fillForm(lastSaved);
    pendingChange=false;
    closeConfirm();
  });
  // prevent closing by clicking backdrop (forced decision)
  csModal.addEventListener('click', (e)=>{
    const dlg = e.target.closest('.dialog');
    if(!dlg) e.stopPropagation(); // do nothing; keep modal open
  });

  // Export do
  doExport.addEventListener('click', ()=>{
    const langSel = expLang.value;
    const L = I18N[langSel] || I18N.en;
    const scope = expScope.value;
    const fmt   = expFormat.value;

    let periodLabel = '';
    const basePerDay = Math.round(parseFloat(stDaily.value||8)*60);

    if(scope==='day'){
      periodLabel = dayDate.value;
      if(fmt==='png'){ exportDayPNGWithLang(L); }
      else{ exportDayJSONWithLang(langSel); }
      exportModal.classList.remove('open'); return;
    }
    if(scope==='month'){
      const month = monthPick.value || dayDate.value.slice(0,7);
      const [y,mo]=month.split('-').map(Number);
      const first=new Date(y,mo-1,1), last=new Date(y,mo,0);
      const {rows,annotations} = buildDataForRange(first, last, basePerDay);
      periodLabel = month;
      if(fmt==='png'){ exportPeriodPNG(L, L.month.title, periodLabel, rows, annotations); }
      else{ exportRowsJSON('month', periodLabel, rows, langSel, annotations); }
      exportModal.classList.remove('open'); return;
    }
    if(scope==='biweek'){
      const start = bwStart.value ? new Date(bwStart.value) : new Date();
      const end   = new Date(start); end.setDate(start.getDate()+13);
      const {rows,annotations} = buildDataForRange(start, end, basePerDay);
      periodLabel = periodLabelFromDates(start,end);
      const titleText = (L.export.optBi || 'Two Weeks');
      if(fmt==='png'){ exportPeriodPNG(L, titleText, periodLabel, rows, annotations); }
      else{ exportRowsJSON('biweek', periodLabel, rows, langSel, annotations); }
      exportModal.classList.remove('open'); return;
    }
  });

  // Init
  try{dayDate.valueAsDate=new Date();}catch{dayDate.value=new Date().toISOString().slice(0,10);}
  setLang(currentLang);
  loadSettings();
  loadDay();
  compute();
  updateBalanceBar();

  // Keep dark toggle UI
  darkToggle.checked = document.body.classList.contains('dark');
}
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initApp);}else{initApp();}
</script>
</body>
  </html>
