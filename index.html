<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import {
    getAuth,
    setPersistence,
    browserLocalPersistence,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    GoogleAuthProvider,
    signInWithPopup,
    signInWithRedirect,
    getRedirectResult,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

  (async function main(){
    /* ===== Firebase ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyBpzQ4GRDzdYCuMvsj3rrWN8Ck0GLHiB2g",
      authDomain: "saaati-pro.firebaseapp.com",
      projectId: "saaati-pro",
      storageBucket: "saaati-pro.firebasestorage.app",
      messagingSenderId: "719485178559",
      appId: "1:719485178559:web:56460b57bb0560d8496c0a",
      measurementId: "G-2KBHPQP07X"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    try {
      await setPersistence(auth, browserLocalPersistence);
    } catch(e) {
      console.warn('setPersistence error:', e);
    }
    const providerGoogle = new GoogleAuthProvider();

    /* ===== I18N (Ù†ÙØ³ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©) ===== */
    const I18N = {
      en:{dir:'ltr',brand:'Saaati',title:'Sign in',subtitle:'Sign in or create an account to sync your data across devices.',
        email:'Email',password:'Password',login:'Sign in',signup:'Create new account',google:'Continue with Google',skip:'Skip for now',back:'â† Back to app',
        err:{empty:'Please enter email and password.','auth/invalid-email':'Invalid email address.','auth/user-not-found':'No user found with this email.',
             'auth/wrong-password':'Incorrect password.','auth/weak-password':'Password should be at least 6 characters.',
             'auth/popup-blocked':'Popup was blocked. Trying redirect...','auth/popup-closed-by-user':'Popup closed. Trying redirect...',
             'auth/unauthorized-domain':'This domain is not authorized in Firebase.',default:'Unexpected error: '}},
      ar:{dir:'rtl',brand:'Ø³Ø§Ø¹ØªÙŠ',title:'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',subtitle:'Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§ Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¹Ø¨Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©.',
        email:'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',password:'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',login:'Ø¯Ø®ÙˆÙ„',signup:'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯',google:'Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google',skip:'ØªØ®Ø·ÙŠ Ø§Ù„Ø¢Ù†',back:'â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚',
        err:{empty:'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.','auth/invalid-email':'Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­.','auth/user-not-found':'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯.',
             'auth/wrong-password':'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.','auth/weak-password':'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.',
             'auth/popup-blocked':'ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©. Ø³ÙŠÙØ¬Ø±Ù‘Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„...','auth/popup-closed-by-user':'ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©. Ø³ÙŠÙØ¬Ø±Ù‘Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„...',
             'auth/unauthorized-domain':'Ù‡Ø°Ø§ Ø§Ù„Ù†Ø·Ø§Ù‚ ØºÙŠØ± Ù…ØµØ±Ù‘Ø­ Ø¨Ù‡ ÙÙŠ Firebase.',default:'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: '}},
      de:{dir:'ltr',brand:'Meine Stunden',title:'Anmelden',subtitle:'Melde dich an oder erstelle ein Konto, um deine Daten zu synchronisieren.',
        email:'E-Mail',password:'Passwort',login:'Anmelden',signup:'Neues Konto erstellen',google:'Mit Google fortfahren',skip:'Jetzt Ã¼berspringen',back:'â† Zur App',
        err:{empty:'Bitte E-Mail und Passwort eingeben.','auth/invalid-email':'UngÃ¼ltige E-Mail-Adresse.','auth/user-not-found':'Kein Benutzer mit dieser E-Mail gefunden.',
             'auth/wrong-password':'Falsches Passwort.','auth/weak-password':'Passwort muss mind. 6 Zeichen haben.',
             'auth/popup-blocked':'Popup blockiert. Redirect wird versucht...','auth/popup-closed-by-user':'Popup geschlossen. Redirect wird versucht...',
             'auth/unauthorized-domain':'Diese Domain ist in Firebase nicht autorisiert.',default:'Unerwarteter Fehler: '}}
    };

    const LS_LANG='saaati_lang';
    let currentLang = localStorage.getItem(LS_LANG) || 'en';

    /* ===== Refs ===== */
    const themeBtn = document.getElementById('themeBtn');
    const langBtn  = document.getElementById('langBtn');
    const langMenu = document.getElementById('langMenu');
    const langLabel= document.getElementById('langLabel');

    const brandTxt = document.getElementById('brandTxt');
    const title    = document.getElementById('title');
    const subtitle = document.getElementById('subtitle');
    const lblEmail = document.getElementById('lblEmail');
    const lblPassword = document.getElementById('lblPassword');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn= document.getElementById('signupBtn');
    const googleBtn= document.getElementById('googleBtn');
    const btnGoogleText = document.getElementById('btnGoogleText');
    const skipBtn  = document.getElementById('skipBtn');
    const backToApp= document.getElementById('backToApp');

    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const errorBox = document.getElementById('errorBox');

    /* ===== Theme ===== */
    function setThemeIcon(){
      const isDark = document.body.classList.contains('dark');
      themeBtn.textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
      themeBtn.setAttribute('aria-label', isDark ? 'Switch to Light' : 'Switch to Dark');
    }
    themeBtn.onclick = ()=>{ document.body.classList.toggle('dark'); setThemeIcon(); };

    /* ===== Lang ===== */
    function updateLangLabel(){ langLabel.textContent = (currentLang==='ar'?'AR': currentLang==='de'?'DE':'EN'); }
    function tErr(code){ const L=I18N[currentLang]||I18N.en; return L.err[code] || (L.err.default + code); }
    function setLang(lang){
      currentLang=lang; const L=I18N[lang]||I18N.en;
      document.documentElement.lang=lang; document.documentElement.dir=L.dir; document.body.dir=L.dir;
      brandTxt.textContent=L.brand; title.textContent=L.title; subtitle.textContent=L.subtitle;
      lblEmail.textContent=L.email; lblPassword.textContent=L.password;
      loginBtn.textContent=L.login; signupBtn.textContent=L.signup; btnGoogleText.textContent=L.google;
      skipBtn.textContent=L.skip; backToApp.textContent=L.back;
      localStorage.setItem(LS_LANG,lang); updateLangLabel(); setThemeIcon();
    }
    langBtn.addEventListener('click',(e)=>{ e.stopPropagation(); const willOpen=!langMenu.classList.contains('open'); langMenu.classList.toggle('open',willOpen); langBtn.setAttribute('aria-expanded',String(willOpen)); });
    langMenu.addEventListener('click',(e)=>e.stopPropagation());
    window.addEventListener('click',()=>{ langMenu.classList.remove('open'); langBtn.setAttribute('aria-expanded','false'); });
    window.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ langMenu.classList.remove('open'); langBtn.setAttribute('aria-expanded','false'); }});
    langMenu.querySelectorAll('.lang-opt').forEach(opt=>{
      opt.addEventListener('click', ()=>{
        const lang=opt.dataset.lang; setLang(lang);
        langMenu.querySelectorAll('.lang-opt').forEach(o=>o.dataset.active=(o.dataset.lang===lang)?'true':'false');
        langMenu.classList.remove('open'); langBtn.setAttribute('aria-expanded','false');
      });
    });

    /* ===== Errors UI ===== */
    function showError(msg){
      errorBox.textContent = msg;
      errorBox.style.display = 'block';
      setTimeout(()=> errorBox.style.display='none', 5000);
    }
    function requireFields(){
      if(!emailInput.value.trim() || !passwordInput.value.trim()){
        showError(tErr('empty')); return false;
      }
      return true;
    }

    /* ===== Auth actions ===== */
    loginBtn.addEventListener('click', async ()=>{
      try{
        if(!requireFields()) return;
        await signInWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value.trim());
        window.location.href='index.html';
      }catch(err){ showError(tErr(err.code)); console.error(err); }
    });

    signupBtn.addEventListener('click', async ()=>{
      try{
        if(!requireFields()) return;
        await createUserWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value.trim());
        window.location.href='index.html';
      }catch(err){ showError(tErr(err.code)); console.error(err); }
    });

    googleBtn.addEventListener('click', async ()=>{
      try{
        await signInWithPopup(auth, providerGoogle);
        window.location.href='index.html';
      }catch(err){
        if(err?.code==='auth/popup-blocked' || err?.code==='auth/popup-closed-by-user'){
          showError(tErr(err.code));
          try{
            await signInWithRedirect(auth, providerGoogle);
          }catch(e2){ showError(tErr(e2.code)); console.error(e2); }
        }else{
          showError(tErr(err.code)); console.error(err);
        }
      }
    });

    // Redirect result (fallback)
    try{
      const result = await getRedirectResult(auth);
      if(result && result.user){ window.location.href='index.html'; }
    }catch(err){ showError(tErr(err.code)); console.error(err); }

    skipBtn.addEventListener('click', ()=>{ window.location.href='index.html'; });

    // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ø®Ù„ Ø£Ø³Ø§Ø³Ø§Ù‹
    onAuthStateChanged(auth, (user)=>{ if(user) window.location.href='index.html'; });

    // Init
    if(!localStorage.getItem(LS_LANG)){ localStorage.setItem(LS_LANG,'en'); currentLang='en'; }
    setLang(currentLang); setThemeIcon();
  })();
</script>
